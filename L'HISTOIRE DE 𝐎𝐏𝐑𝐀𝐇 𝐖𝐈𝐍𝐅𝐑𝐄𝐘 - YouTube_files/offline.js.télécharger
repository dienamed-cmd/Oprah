(function(g){var window=this;'use strict';var bJ$=function(d){const L=new g.Pi("und",new g.Zz("Default","und",!0));L.captionTracks=d.captionTracks;return L},HJ1=function(d){return new g.f9(function(L,I){let v=d.length;
const F=[];if(v){var R=function(b,H){v--;F[b]=H;v==0&&L(F)},D=function(b){I(b)};
for(let b=0;b<d.length;b++){var O=d[b];g.Fb(O,g.zF(R,b),D)}}else L(F)})},ec=function(d){return g.Fj((0,g.dZN)(),d)},nJc=function({type:d,
payload:L}){d={type:d};L!==void 0&&(d.payload=L);return d},Wp=function(d){d=d.key||d.id;
if(!d)throw Error("Entity key is missing");return d},oJU=function(){if(aU)return aU();
aU=g.r9("PersistentEntityStoreDb",{fL:{EntityStore:{i$:1},EntityAssociationStore:{i$:2}},shared:!1,upgrade(d,L){L(1)&&g.gu(g.fX(d,"EntityStore",{keyPath:"key"}),"entityType","entityType");L(2)&&(d=g.fX(d,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.gu(d,"byParentEntityKey","parentEntityKey"),g.gu(d,"byChildEntityKey","childEntityKey"))},version:3});return aU()},ygn=function(d){return g.Fj(oJU(),d)},rgU=function(d){return d instanceof Error?new Bp("UNKNOWN_ENCODE_ERROR",
{originalMessage:d.message}):new Bp("UNKNOWN_ENCODE_ERROR")},kac=function(d){return d instanceof Error?new Bp("UNKNOWN_DECODE_ERROR",{originalMessage:d.message}):new Bp("UNKNOWN_DECODE_ERROR")},KRb=function(d,L){d=d instanceof Bp?d:L(d);
g.Z(d);throw d;},eFU=function(d,L,I){try{return d.G(L,I)}catch(v){KRb(v,rgU)}},jc=function(d){d=(new TextEncoder).encode(d).subarray(0,16);
const L=new Uint8Array(16);L.set(d);return L},a0n=function(d){const L=WRL[d];
if(L)return L;g.mG(new g.lQ("Entity model not found.",{entityType:d}))},Aw=function(d,L){a:{d=tw(d.W,L.version);
try{var I=d.W(L.data,L.key);break a}catch(v){KRb(v,kac)}I=void 0}return I},pS=function(d,L,I){return d.O.objectStore("EntityStore").get(L).then(v=>{if(v){if(I&&v.entityType!==I)throw Error("Incorrect entity type");
return Aw(d,v)}})},Pp=function(d,L,I){return I?(I=I.map(v=>pS(d,v,L)),g.lq.all(I)):d.O.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(L)).then(v=>v.map(F=>Aw(d,F)))},j_U=function(d,L,I){const v=Wp(L);
return Gn(d,v).then(()=>Bfw(d,L,I))},uw=function(d,L,I){let v=d.G[I];
v||(v=new Set,d.G[I]=v);v.add(L)},m2=function(d,L,I){const v=Wp(L),F=tw(d.W,1),R={...L};
return d.O.objectStore("EntityStore").get(v).then(D=>{if(D){if(D.entityType!==I)throw Error("Incorrect entity type");R.entityMetadata||(D=Aw(d,D),R.entityMetadata=D.entityMetadata)}}).then(()=>{const D={key:v,
entityType:I,data:eFU(F,R,v),version:1};return g.lq.all([d.O.objectStore("EntityStore").put(D),j_U(d,R,I)])}).then(()=>{uw(d,v,I);
return v})},zn=function(d,L,I){L=L.map(v=>m2(d,v,I));
return g.lq.all(L)},Agb=function(d,L,I){if(I.has(L))return g.lq.resolve(void 0);
I.add(L);return t8Q(d,L).then(v=>d.O.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(L)).then(()=>v)).then(v=>{let F=g.lq.resolve(void 0);
for(const R of v)F=F.then(()=>Agb(d,R,I));
return F}).then(()=>{})},E1=function(d,L,I){if(I?.lR){const F=new Set;
return Agb(d,L,F).then(()=>{const R=[];for(const D of F)R.push(E1(d,D));return g.lq.all(R).then(()=>{})})}const v=g.AS(L).entityType;
return g.lq.all([d.O.objectStore("EntityStore").delete(L),Gn(d,L)]).then(()=>{uw(d,L,v)})},Gn=function(d,L){return d.O.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(L))},hw=function(d,L){return g.Iy(d.O.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(L)},I=>g.lq.all([I.delete(),
Gn(d,I.cursor.primaryKey)]).then(()=>{uw(d,I.cursor.primaryKey,L);return g.LD(I)}))},pHj=function(d,L,I,v){const F=tw(d.W,1);
return pS(d,L,v).then(R=>{if(R){R=g.Lw(R,I);var D={key:L,entityType:v,data:eFU(F,R,L),version:1};return g.lq.all([d.O.objectStore("EntityStore").put(D),j_U(d,R,v)])}}).then(()=>{uw(d,L,v);
return L})},Bfw=function(d,L,I){const v=Wp(L);
I=a0n(I);if(!I)return g.lq.resolve([]);L=new I(L);d=d.O.objectStore("EntityAssociationStore");I=[];for(const F of L.W())I.push(d.put({parentEntityKey:v,childEntityKey:F}));return g.lq.all(I).then(F=>F.map(R=>R[1]))},t8Q=function(d,L){const I=d.O.objectStore("EntityAssociationStore");
return I.index("byParentEntityKey").getAll(IDBKeyRange.only(L)).then(v=>{const F=[];for(const R of v)F.push(I.index("byChildEntityKey").getAll(R.childEntityKey));return g.lq.all(F)}).then(v=>{const F=[];
for(const R of v)R.length===1&&F.push(R[0].childEntityKey);return F})},tw=function(d,L=0){d=d.O[L];
if(!d)throw L=new Bp("INVALID_ENCODER_VERSION",{Um:L}),g.Z(L),L;return d},PQj=function(d,L){for(const I of d.observers)I(L)},wl=async function(d,L,I){var v=await ygn(d.token);
let F;L=await g.Vt(v,["EntityStore","EntityAssociationStore"],L,R=>{F=new GaU(R,d.O);return I(F)});
F&&(v=F.G,Object.keys(v).length>0&&(d.channel.postMessage(v),PQj(d,v)));return L},Jw=function(d,L,I){return wl(d,{mode:"readwrite",
Bx:!0},v=>m2(v,L,I))},uw9=function(d,L){return wl(d,{mode:"readwrite",
Bx:!0},I=>zn(I,L,"offlineOrchestrationActionWrapperEntity"))},CS=function(d,L){return wl(d,{mode:"readwrite",
Bx:!0},I=>E1(I,L))},mIV=function(d){return wl(d,{mode:"readwrite",
Bx:!0},L=>hw(L,"videoPlaybackPositionEntity"))},iw=function(d,L,I){return wl(d,{mode:"readonly",
Bx:!0},v=>pS(v,L,I))},$L=function(d,L,I){return wl(d,{mode:"readonly",
Bx:!0},v=>Pp(v,L,I))},hF$=async function(){try{const L=await g.yo();
if(L&&g.tM()&&typeof g.er.BroadcastChannel!=="undefined"){var d=new zFc;return new EJ9(L,d)}}catch(L){L instanceof Error&&g.Z(L)}},YL=function(){xL||(xL=hF$());
return xL},wHb=function(d){d=d.options?.persistenceOption;
return d==="ENTITY_PERSISTENCE_OPTION_PERSIST"||d==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},Jgn=async function(d){const L=await YL();
L&&await wl(L,"readwrite",I=>{const v={};for(const F of d){if(!F.entityKey||!wHb(F))continue;const R=g.hc(F.payload);let D=void 0;F.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(D=()=>m2(I,F.payload[R],R));
F.type==="ENTITY_MUTATION_TYPE_DELETE"&&(D=()=>E1(I,F.entityKey));
F.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(D=()=>pHj(I,F.entityKey,F.payload[R],R));
D&&(v[F.entityKey]=v[F.entityKey]?v[F.entityKey].then(D):D())}return g.lq.all(Object.values(v))})},Sc=async function(d){!(d=d.mutations)||d.length<=0||(g.bu&&g.bu.dispatch(nJc({type:"ENTITY_LOADED",
payload:d})),await Jgn(d),d.length=0)},CQb=function(d){return d!==void 0},iJb=function(d){var L=g.qf();
L=Object.assign({},L);d=Object.assign({},d);for(const I in L)d[I]?(L[I]!==4&&(L[I]=d[I]),delete d[I]):L[I]!==2&&(L[I]=4);Object.assign(L,d);g.kMO(L);JSON.stringify(L);return L},$I9=async function(d){const L=await g.yo();
return L?g.Vt(await g.Nf(L),["index","media","captions"],{mode:"readwrite",Bx:!0},I=>{const v=IDBKeyRange.bound(d+"|",d+"~");I=[I.objectStore("index").delete(v),I.objectStore("media").delete(v),I.objectStore("captions").delete(v)];return g.lq.all(I).then(()=>{})}):void 0},xI1=async function(){const d=await g.yo();
if(!d)throw g.qK("rvdfd");return g.Vt(await g.Nf(d),["index","media"],{mode:"readwrite",Bx:!0},L=>{const I={};return g.d9(L.objectStore("index"),{},v=>{var F=v.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let R=g.lq.resolve(void 0);if(F){const D=F[1];F=F[2];I[D]=I[D]||{};I[D][F]=g.aON(v.getValue()?.fmts)}else R=v.delete().then(()=>{});
return g.lq.all([g.LD(v),R]).then(([D])=>D)}).then(()=>{const v={};
for(const R of Object.keys(I)){const D=I[R].v;v[R]=I[R].a&&D?1:2}const F=iJb(v);return g.NbF(L.objectStore("media"),{},R=>{const D=R.cursor.key.match(g.Au7);D&&v[D[1]]||L.objectStore("media").delete(R.cursor.key);return g.xjS(R)}).then(()=>F)})})},YZH=async function(d,L){var I=await g.yo();
if(!I)throw g.qK("wct");I=await g.Nf(I);await g.Vt(I,["captions"],{mode:"readwrite",Bx:!0},v=>{const F=[];v=v.objectStore("captions");for(let R=0;R<L.length;R++){const D=v.put(L[R],d+"|"+L[R].metadata.vss_id);F.push(D)}return g.lq.all(F)})},SZn=async function(d){d=IDBKeyRange.bound(d+"|",d+"~");
const L=await g.yo();if(!L)throw g.qK("gactfv");return(await g.Nf(L)).getAll("captions",d)},UI1=async function(d){g.Z9(d,0);
return $I9(d)},s_w=function(d){return{context:g.n2(),
videoIds:d}},qZ8=function(d){return{context:g.n2(),
playlistIds:d}},l0Q=function(d){return{context:g.n2(),
offlinePlaylistSyncChecks:d}},Nfc=function(){U1||(U1=new ZJx);
return U1},Q_H=async function(d,L,I){var v=g.Hl(),F=I.refreshData,R=I.isEnqueuedForExpiredStreamUrlRefetch,D=I.Ho,O=I.offlineSourceData;
I=I.mediaCapabilities;d={entityKey:d};F&&(d.refreshData=F);R&&(d.isExpiredStreamUrlRefetch=R);D&&(d.downloadParameters=D);O&&(d.offlineSourceData=O);L={context:g.QD(L),signatureTimestamp:20486,videos:[d]};I&&(L.mediaCapabilities=I);F=g.yy(M8n);try{var b=await g.IY(v,L,F,void 0,{MQ:!0})}catch(H){if(H instanceof g.sH)throw b=`GetPDE network manager error: ${H.message}`,s1(b,H),Error(b);s1("GetPDE fetch request error",H);throw Error("GetPDE fetch request error");}v=b.errorMetadata?.status;if(b)v!==void 0&&
qV(v,"PDE");else throw s1("Network request failed for PDE"),Error("Network request failed for PDE");return b},cgQ=function(d,L){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:d},metadata:L,statusCode:void 0,csn:void 0,can:void 0}},V8$=function(d,L,I){I||(I=d.O.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),I||(I=g.jk(16),d.O.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",I)));
d={flowNonce:I,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:L.eventType};L.metadata&&(d.flowMetadata=L.metadata);L.statusCode!==void 0&&(d.flowEventStatus=L.statusCode);L.csn&&(d.csn=L.csn);L.can&&(d.can=L.can);g.a6("flowEvent",d,void 0)},f09=async function(d){var L=await wl(d,{mode:"readonly",
Bx:!0},k=>Pp(k,"playbackData").then(W=>{var P=W.map(C=>C.transfer).filter(C=>!!C),z=W.map(C=>C.offlineVideoPolicy).filter(C=>!!C),w=W.filter(C=>!!C.key).map(C=>g.pw(g.AS(C.key).entityId,"downloadStatusEntity"));
P=Pp(k,"transfer",P);z=Pp(k,"offlineVideoPolicy",z);w=Pp(k,"downloadStatusEntity",w);const E=P.then(C=>{C=C.reduce((S,Ri)=>{Ri?.offlineVideoStreams&&S.push(...Ri.offlineVideoStreams);return S},[]).filter(S=>!!S);
return Pp(k,"offlineVideoStreams",C)});
return g.lq.all([P,z,E,w]).then(([C,S,Ri,O$])=>[W,C,S,Ri,O$])}));
d=await wl(d,{mode:"readonly",Bx:!0},k=>Pp(k,"mainDownloadsListEntity").then(W=>W[0]?.downloads??[]));
const [I,v,F,R,D]=L,O={},b={},H={},n={},y={};L=[];for(var r of v)r&&(O[r.key]=r);for(const k of F)k&&(b[k.key]=k);for(const k of D)k&&(H[k.key]=k);for(const k of R)k&&(n[k.key]=k);for(const k of d)y[k.videoItem??""]=!0,k.videoItem&&(r=g.AS(k.videoItem)?.entityId??"",L.push({externalVideoId:r}));return{offlineVideos:I.filter(k=>{if(!k||!k.key||!k.offlineVideoPolicy)return!1;k=g.AS(k.key).entityId;k=g.pw(k,"downloadStatusEntity");return!(k&&H[k]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(k=>
{var W=O[k.transfer];
const P=[];if(W?.offlineVideoStreams)for(var z of W.offlineVideoStreams){var w=n[z];w&&P.push(w)}z=b[k.offlineVideoPolicy];w=k?.playerResponseTimestamp;var E=g.AS(z.key).entityId;k=g.pw(E,"mainVideoEntity");if(z.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var C="OFFLINE_VIDEO_STATE_DISABLED";z.expirationTimestamp&&Number(z.expirationTimestamp)<Date.now()/1E3&&(C="OFFLINE_VIDEO_STATE_EXPIRED")}else if(z.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")C="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(W?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":C="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":C="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":C="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":C="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":C="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":C="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:C="OFFLINE_VIDEO_STATE_UNKNOWN"}if(C==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(W?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":C="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":C="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":C="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}E={id:E,videoState:C};
W?.cotn&&(E.cotn=W.cotn);W?.maximumDownloadQuality&&(E.selectedVideoQuality=W?.maximumDownloadQuality);W?.lastProgressTimeMs&&(E.lastProgressTimeMs=W.lastProgressTimeMs);w&&(E.playerResponseSavedTimeMs=String(Number(w)*1E3));W=String;w=0;for(const S of P)if(S.streamsProgress)for(const Ri of S.streamsProgress)w+=Number(Ri.numBytesDownloaded??0);E.downloadedBytes=W(w);E.selectedOfflineMode=y[k]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";z.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(E.offlinePlaybackDisabledReason=
z.offlinePlaybackDisabledReason);return E}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:L}}}},gJH=function(){try{let I=g.ai("ytglobal.locks_");
if(I)return I;var d;if(d=navigator){var L=navigator;d="locks"in L&&!!L.locks}if(d)return g.er.localStorage&&g.er.localStorage.getItem("noop"),I=new Tfb,g.WB("ytglobal.locks_",I),I}catch{}},lw=function(d){if(d.includes(":"))throw Error(`Invalid user cache name: ${d}`);
return`${d}:${g.jy("CacheStorage get")}`},XHn=async function(){return Z8!==void 0?Z8:Z8=new Promise(async d=>{try{await NV.open("test-only"),await NV.delete("test-only")}catch(L){if(L instanceof Error&&L.name==="SecurityError"){d(!1);
return}}d("caches"in window)})},QZ=async function(){if(await XHn())return MV||(MV=new djj),MV},s1=function(d,L,I){g.mG(new g.lQ(`Woffle: ${d}`,I?{cotn:I}:""));
L instanceof Error&&g.mG(L)},LUj=async function(d){d=await f09(d);
g.a6("offlineStateSnapshot",d)},cp=function(d,L){g.cg(d.api,"onOfflineOperationFailure",L);
d.O?.postMessage(L)},Itx=function(d){if(!d.G&&!d.O){var L=gJH();
if(L){d.G=!0;var I=g.jy("OfflineLockManager");L.request(`${"woffle_orchestration_leader"}:${I}`,{},async()=>{try{d.W=new g.AA,d.O=!0,d.G=!1,await d.j(),await d.W.promise}catch(v){d.pu(),v instanceof Error&&(v.args=[{name:"WoLockManagerError",sD:v.name}],g.Z(v))}})}}},VZ=function(d){d.B&&d.K&&d.L&&d.visibility.isBackground()?d.N.DY(6E4):d.N.stop()},vT1=function(d){d.O&&(d.L=!0,VZ(d))},FU$=function(d,L){d.O&&(d.K=L,VZ(d))},RtQ=function(d,L){d.O&&(d.B=L,VZ(d))},fS=function(d){d.offlineDeleteReason=d.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
d.offlineModeType=d.offlineModeType??"OFFLINE_NOW";g.a6("offlineDeleteEvent",d)},Tn=function(d,{videoId:L,
pT:I,offlineModeType:v}){d.encryptedVideoId=L;d.cotn=I?.cotn;d.offlineabilityFormatType=I?.maximumDownloadQuality;d.isRefresh=I?.isRefresh??!1;d.softErrorCount=I?.transferRetryCount??0;d.offlineModeType=v??"OFFLINE_NOW";(d.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&d.statusType==="UNKNOWN_STATUS_TYPE"||!d.transferStatusType&&!d.statusType)&&g.mG(Error("Woffle unknown transfer status"));g.a6("offlineTransferStatusChanged",d)},Djw=function(d,L,I,v){v={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!v};L&&I&&(L=Math.floor(L/1024).toFixed(),I=Math.floor(I/1024).toFixed(),v.alreadyDownloadedKbytes=L,v.totalFetchedKbytes=L,v.totalContentKbytes=I);Tn(v,d)},Omw=function(d){Tn({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},d)},bmQ=function(d){switch(d){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
gl=function(d){return(d.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},X9=function(d){return d.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!d.entityKey},d7=function(d){return d.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!d.entityKey},LZ=function(d){return d.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!d.entityKey},Hm$=function(d){return d.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!d.entityKey},IX=async function(d,L,I,v,F=!1){const R=
g.pw(d,L),D=g.pw(d,"downloadStatusEntity");
d=await wl(I,{mode:"readonly",Bx:!0},b=>g.lq.all([pS(b,R,L),pS(b,D,"downloadStatusEntity")]));
const O=d.length?d[0]:void 0;if(O){let b=d.length>1?d[1]:void 0;if(b){if(b.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!F)return;b.downloadState=v}else b={key:D,downloadState:v};g.sG(O,nTn,b);await wl(I,{mode:"readwrite",Bx:!0},H=>g.lq.all([m2(H,O,L),m2(H,b,"downloadStatusEntity")]))}},vQ=function(d,L){return d.actionType===L.actionType&&d.entityKey===L.entityKey},FD=function(d,L){if(d&&d.transferState!=="TRANSFER_STATE_COMPLETE"&&d.transferState!=="TRANSFER_STATE_FAILED"){const I=g.AS(d.key).entityId;
Tn({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:I,pT:d,offlineModeType:L})}},RX=function(d){if(!d||!d.thumbnails)return[];
const L=[];for(const I of d.thumbnails)I.url&&L.push(I.url);return L},DX=async function(d,L,I=[]){if(!I.length)return[];
L=await $L(d,L);d=new Set;for(var v of L)if(L=v.id||v.key)L=g.AS(L).entityId,d.add(L);v=[];for(const F of I)I=F.offlineVideoData,I?.videoId&&!d.has(I.videoId)&&v.push(F);return v},OO=function(d,L,I){return new g.ki(d,{cotn:L,
raw_player_response:I,download_media:!0,start:Infinity,disable_watch_next:!0})},bo=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},nZ=function(d){if(!d.key)throw Error("Entity key is required.");
if(!d.actionProto)throw Error("OfflineOrchestrationAction is required.");const L=g.AS(d.key),I=g.AS(d.actionProto.entityKey);return new HQ(I.entityType,L.entityId,d.actionProto,d.parentActionId,d.rootActionId,d.childActionIds,d.prereqActionId,d.postreqActionIds,d.retryScheduleIndex,d.hasChildActionFailed,Number(d.enqueueTimeSec)*1E3)},oX=function(d){return{key:g.pw(d.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:d.action,parentActionId:d.parentActionId,rootActionId:d.rootActionId,childActionIds:d.childActionIds,prereqActionId:d.prereqActionId,postreqActionIds:d.postreqActionIds,retryScheduleIndex:d.retryScheduleIndex,hasChildActionFailed:d.hasChildActionFailed,enqueueTimeSec:(d.O/1E3).toFixed()}},oT$=async function(){const d=await QZ();
return d?d.delete("yt-player-local-img"):!0},yv=async function(d){const L=await QZ();
if(!L)throw Error("Cache API not supported");if(d.length){var I=await L.open("yt-player-local-img");await Promise.all(d.map(v=>I.delete(v)))}},r7=async function(d){const L=await QZ();
if(!L)throw Error("Cache API not supported");d.length&&await (await L.open("yt-player-local-img")).addAll(d)},k9=async function(d,L,I,v,F){const R=g.pw(d,"mainVideoEntity"),D=g.pw(d,"ytMainChannelEntity"),O=g.pw(d,"transfer"),b=g.pw(d,"videoDownloadContextEntity");
var H=await wl(L,{mode:"readonly",Bx:!0},C=>g.lq.all([pS(C,R,"mainVideoEntity"),pS(C,D,"ytMainChannelEntity"),pS(C,O,"transfer"),pS(C,b,"videoDownloadContextEntity"),Pp(C,"ytMainChannelEntity"),Pp(C,"offlineOrchestrationActionWrapperEntity")]));
const [n,y,r,k,W,P]=H;if(n||y){H=n?RX(n.thumbnail):[];var z=y?await yZQ(y,W):[];await yv(H.concat(z))}const w=[],E=g.pw(d,"downloadStatusEntity");for(const C of P)H=g.AS(C.key).entityId,z=nZ(C),z=g.AS(z.action.entityKey).entityId,H!==d&&z!==d||vQ(I,C.actionProto)||w.push(C.key);await wl(L,{mode:"readwrite",Bx:!0},C=>{const S=w.map(Ri=>E1(C,Ri));
S.push(E1(C,R,{lR:!0}));S.push(E1(C,E,{lR:!0}));return g.lq.all(S)});
d=k?.offlineModeType;F&&(fS(F),F.offlineModeType&&(d=F.offlineModeType));FD(r,d);cp(v,{entityKey:R,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},KZ=async function(d,L,I,v){const F=g.pw(d,"mainPlaylistEntity"),R=g.pw(d,"ytMainChannelEntity");
var D=await wl(L,{mode:"readonly",Bx:!0},C=>g.lq.all([pS(C,F,"mainPlaylistEntity"),pS(C,R,"ytMainChannelEntity"),Pp(C,"mainPlaylistEntity"),Pp(C,"mainDownloadsListEntity"),Pp(C,"ytMainChannelEntity"),Pp(C,"offlineOrchestrationActionWrapperEntity")]));
const [O,b,H,n,y,r]=D;if(O||b){D=O?rZQ(O):[];var k=b?await yZQ(b,y):[];await yv(D.concat(k))}D=[];k=new Map;if(O){D=await k51(O,H,n);for(var W of D)k.set(W,{videoId:W,playlistId:d,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});W=await wl(L,{mode:"readonly",Bx:!0},Ri=>g.lq.all([Pp(Ri,"transfer"),Pp(Ri,"videoDownloadContextEntity")]));
const [C,S]=W;for(var P of C)W=g.AS(P.key).entityId,(W=k.get(W))&&P&&(W.cotn=P.cotn);for(var z of S)P=g.AS(z.key).entityId,(P=k.get(P))&&z&&(P.offlineModeType=z.offlineModeType)}const w=[];for(const C of r)z=g.AS(C.key).entityId,P=nZ(C),z!==d&&P.rootActionId!==d||vQ(I,C.actionProto)||w.push(C.key);const E=g.pw(d,"mainPlaylistEntity");await wl(L,{mode:"readwrite",Bx:!0},C=>{const S=w.map(Ri=>E1(C,Ri));
S.push(E1(C,E,{lR:!0}));return g.lq.all(S)});
if(O&&(D.reverse(),D))for(const C of D)await k9(C,L,I,v,k.get(C))},ew=async function(d,L,I,v){const F=g.pw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),R=new Map;
d=await wl(d,{mode:"readwrite",Bx:!0},D=>{const O=Pp(D,"transfer"),b=Pp(D,"offlineOrchestrationActionWrapperEntity"),H=Pp(D,"videoDownloadContextEntity"),n=pS(D,F,"mainDownloadsListEntity");return g.lq.all([O,b,H,n]).then(([y,r,k,W])=>{const P=KUb.map(z=>hw(D,z));
for(const z of r)vQ(L,z.actionProto)||P.push(E1(D,z.key,{lR:!0}));W&&(W.downloads=[],P.push(m2(D,W,"mainDownloadsListEntity")));if(k)for(const z of k)r=g.AS(z.key).entityId,r=g.pw(r,"transfer"),R.set(r,z.offlineModeType);return g.lq.all(P).then(()=>y)})});
for(const D of d){FD(D,R.get(D.key));d=g.AS(D.key).entityId;const O={videoId:d,offlineDeleteReason:v,cotn:D.cotn,offlineModeType:R.get(D.key)};fS(O);d=g.pw(d,"mainVideoEntity");cp(I,{entityKey:d,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await oT$()},rZQ=function(d,L){let I=[];
if(d.thumbnailStyleData)for(const v of d.thumbnailStyleData)I=I.concat(RX(v?.value?.collageThumbnail?.coverThumbnail));d=RX(L);return I.concat(d)},k51=async function(d,L,I){const v=[],F=new Set;
if(I.length)for(var R of I)if(R.downloads?.length)for(const D of R.downloads)D.videoItem&&(I=g.AS(D.videoItem).entityId,F.add(I));if(d.videos){for(const D of d.videos)R=JSON.parse(g.AS(D).entityId),R.videoId&&!F.has(R.videoId)&&v.push(R.videoId);for(const D of L)if(D.key!==d.key&&(L=D.videos))for(const O of L)L=JSON.parse(g.AS(O).entityId),L.videoId&&(L=v.indexOf(L.videoId),L!==-1&&v.splice(L,1))}return v},yZQ=async function(d,L){const I=RX(d.avatar);
for(const v of L)if(v.id!==d.id)for(const F of RX(v.avatar))L=I.indexOf(F),L!==-1&&I.splice(L,1);return I},etw=async function(d){const L=g.U(d.frameworkUpdates,WQ);
d.frameworkUpdates&&L&&await Sc(L)},BbQ=function(d){if(d.onResponseReceivedActions?.length&&(d=g.U(g.U(d.onResponseReceivedActions[0],WU1),at8)?.actions,d?.length))return d},j5x=async function(d){if(!d)return[];
d=await iw(d,aX,"mainDownloadsListEntity");return d?.downloads?.length?d.downloads.map(L=>L.videoItem??""):[]},BQ=async function(d,L){const I=await tK9(d,L);
I&&await wl(d,{mode:"readwrite",Bx:!0},v=>{const F=[m2(v,I.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];I.mainDownloadsListEntity&&F.push(m2(v,I.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.lq.all(F)})},tK9=async function(d,L){const I=g.pw("main_downloads_library_id","mainDownloadsLibraryEntity"),v=g.pw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
d=await wl(d,{mode:"readonly",Bx:!0},b=>g.lq.all([pS(b,I,"mainDownloadsLibraryEntity"),pS(b,v,"mainDownloadsListEntity")]));
let [F,R]=d;d=F;let D=R;d||(d={id:I});for(const b of L)if(b===aX){if(d.smartDownloadsList)return;d.smartDownloadsList=b}else{var O=g.AS(b).entityType;L={};O==="mainPlaylistEntity"?L.playlistItem=b:O==="mainVideoEntity"&&(L.videoItem=b);if(!g.Un(L)){if(D?.downloads){O=!1;for(const H of D.downloads)if(H.playlistItem===b||H.videoItem===b){O=!0;break}O||D.downloads.push(L)}else D={id:v,downloads:[L]};d.downloadsList=v}}return{mainDownloadsLibraryEntity:d,mainDownloadsListEntity:D}},jw=async function(d,
L){const I=g.pw("main_downloads_library_id","mainDownloadsLibraryEntity"),v=g.pw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var F=await wl(d,{mode:"readonly",Bx:!0},b=>g.lq.all([pS(b,I,"mainDownloadsLibraryEntity"),pS(b,v,"mainDownloadsListEntity"),pS(b,aX,"mainDownloadsListEntity")]));
const [R,D,O]=F;if(R){if(L===aX&&O?.downloads)O.downloads=[];else if(D?.downloads){F=g.AS(L).entityType;for(let b=0;b<D.downloads.length;b++){const H=D.downloads[b];if(F==="mainVideoEntity"&&H.videoItem===L){D.downloads.splice(b,1);break}else if(F==="mainPlaylistEntity"&&H.playlistItem===L){D.downloads.splice(b,1);break}}}await wl(d,{mode:"readwrite",Bx:!0},b=>{const H=[m2(b,R,"mainDownloadsLibraryEntity")];D&&H.push(m2(b,D,"mainDownloadsListEntity"));O&&H.push(m2(b,O,"mainDownloadsListEntity"));
return g.lq.all(H)})}},tB=async function(d,L){const I=g.pw(L,"transfer"),v=g.pw(L,"videoDownloadContextEntity");
d=await wl(d,{mode:"readonly",Bx:!0},D=>g.lq.all([pS(D,I,"transfer"),pS(D,v,"videoDownloadContextEntity")]));
const [F,R]=d;return{videoId:L,cotn:F?.cotn,offlineModeType:R?.offlineModeType}},AB=async function(d,L,I,v,F){const R=g.pw(d,"musicTrack"),D=g.pw(d,"transfer");
var O=await wl(L,{mode:"readonly",Bx:!0},W=>g.lq.all([pS(W,R,"musicTrack"),pS(W,D,"transfer"),Pp(W,"musicTrack"),Pp(W,"offlineOrchestrationActionWrapperEntity")]));
const [b,H,n,y]=O;b&&(O=await AZ1(b,n),await yv(O));const r=[];for(const W of y){O=g.AS(W.key).entityId;var k=nZ(W);k=g.AS(k.action.entityKey).entityId;O!==d&&k!==d||vQ(I,W.actionProto)||r.push(W.key)}await wl(L,{mode:"readwrite",Bx:!0},W=>{const P=r.map(z=>E1(W,z));
P.push(E1(W,R,{lR:!0}));return g.lq.all(P)});
FD(H);F&&fS(F);cp(v,{entityKey:R,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},pZ=async function(d,L,I,v,F){const R=g.pw(d,L),D=g.pw("music_downloads_library_id","musicDownloadsLibraryEntity");
var O=await wl(I,{mode:"readonly",Bx:!0},w=>g.lq.all([pS(w,R,L),pS(w,D,"musicDownloadsLibraryEntity"),Pp(w,L),Pp(w,"offlineOrchestrationActionWrapperEntity")]));
const [b,H,n,y]=O;b&&(O=await AZ1(b,n),await yv(O));let r=[];O=new Map;if(b){r=await pnL(b,n,H);for(var k of r){const w=g.AS(k).entityId;O.set(w,{videoId:w,playlistId:d,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}k=await $L(I,"transfer");for(var W of k)k=g.AS(W.key).entityId,(k=O.get(k))&&W&&(k.cotn=W.cotn)}const P=[];for(const w of y)W=g.AS(w.key).entityId,k=nZ(w),W!==d&&k.rootActionId!==d||vQ(v,w.actionProto)||P.push(w.key);const z=g.pw(d,L);await wl(I,{mode:"readwrite",Bx:!0},
w=>{const E=P.map(C=>E1(w,C));
E.push(E1(w,z,{lR:!0}));return g.lq.all(E)});
if(b&&(r.reverse(),r.length))for(const w of r)(d=g.AS(w).entityId)&&await AB(d,I,v,F,O.get(d))},PQ=async function(d,L,I){d=await wl(d,{mode:"readwrite",
Bx:!0},v=>{const F=Pp(v,"transfer"),R=Pp(v,"offlineOrchestrationActionWrapperEntity");return g.lq.all([F,R]).then(([D,O])=>{const b=P9U.map(H=>hw(v,H));
for(const H of O){O=g.AS(H.actionProto.entityKey).entityType==="musicTrack";const n=H.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";vQ(L,H.actionProto)||O&&(!O||n)||b.push(E1(v,H.key,{lR:!0}))}return g.lq.all(b).then(()=>D)})});
for(const v of d)FD(v),d=g.AS(v.key).entityId,fS({videoId:d,offlineDeleteReason:void 0,cotn:v.cotn}),d=g.pw(d,"musicTrack"),cp(I,{entityKey:d,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await oT$()},G5Q=function(d){let L;
for(const I of d.additionalMetadatas)I.offlineMusicVideoData&&(L=I.offlineMusicVideoData);return{id:g.pw(d.videoId,"musicTrack"),videoId:d.videoId,title:d.title,thumbnailDetails:d.thumbnail,lengthMs:String(Number(d.lengthSeconds)*1E3),albumTitle:L?.releaseTitle,musicVideoType:L?.musicVideoType,contentRating:{explicitType:L?.explicitType},artistNames:L?.byline||L?.channelName,downloadMetadata:g.pw(d.videoId,"musicTrackDownloadMetadataEntity")}},pnL=async function(d,L,I){const v=[],F=new Set;
if(I?.downloadedTracks?.length)for(const R of I.downloadedTracks)F.add(R);if(d.tracks){for(const R of d.tracks)F.has(R)||v.push(R);for(const R of L)if(R.id!==d.id&&(L=R.tracks))for(const D of L)L=v.indexOf(D),L!==-1&&v.splice(L,1)}return v},AZ1=async function(d,L){const I=RX(d.thumbnailDetails);
for(const v of L)if(v.id!==d.id)for(const F of RX(v.thumbnailDetails))L=I.indexOf(F),L!==-1&&I.splice(L,1);return I},GT=async function(d,L){var I=g.pw("music_downloads_library_id","musicDownloadsLibraryEntity");
let v=await iw(d,I,"musicDownloadsLibraryEntity");v||(v={id:I});I=g.AS(L).entityType;I==="musicTrack"?v.downloadedTracks?.includes(L)||(v.downloadedTracks=(v.downloadedTracks??[]).concat(L)):I==="musicPlaylist"?v.downloadedPlaylists?.includes(L)||(v.downloadedPlaylists=(v.downloadedPlaylists??[]).concat(L)):I!=="musicAlbumRelease"||v.downloadedAlbumReleases?.includes(L)||(v.downloadedAlbumReleases=(v.downloadedAlbumReleases??[]).concat(L));await Jw(d,v,"musicDownloadsLibraryEntity")},uo=async function(d,
L){var I=g.pw("music_downloads_library_id","musicDownloadsLibraryEntity");
if(I=await iw(d,I,"musicDownloadsLibraryEntity")){var v=g.AS(L).entityType;let F;v==="musicTrack"?F=I.downloadedTracks:v==="musicPlaylist"&&(F=I.downloadedPlaylists);if(F?.length)for(v=0;v<F.length;v++)if(F[v]===L){F.splice(v,1);break}await Jw(d,I,"musicDownloadsLibraryEntity")}},uZV=function(d){var L=d.videos;
d=[];const I=[];if(L)for(const F of L){var v=F.offlineVideoData.videoId;L=g.pw(v,"musicTrack");v=g.pw(v,"musicTrackDownloadMetadataEntity");d.push(L);I.push(v)}return{Cd:d,Kd:I}},m4=function(d,L,I){L={track:G5Q(L)};
I&&(L.playlistId=I);if(d=g.U(d.actionMetadata,mj8))L.maximumDownloadQuality=d.maximumDownloadQuality;return{musicTrackEntityActionMetadata:L}},ET$=async function(d){var L=g.Hl();
d=s_w(d);const I=g.yy(ztL);try{var v=await g.IY(L,d,I,void 0,{MQ:!0})}catch(F){if(F instanceof g.sH)throw v=`GetOffline network manager error: ${F.message}`,s1(v,F),Error(v);s1("GetOffline fetch request error",F);throw Error("GetOffline fetch request error");}L=v.errorMetadata?.status;if(!v)throw s1("Network request failed"),Error("Network request failed");if(L!==void 0)qV(L);else if(!v.videos||!v.videos.length)throw s1("No data"),Error("No data");return v.videos.map(F=>F.offlineVideoData)},zT=async function(d){var L=
g.Hl();
d=qZ8(d);const I=g.yy(ztL);try{var v=await g.IY(L,d,I,void 0,{MQ:!0})}catch(F){if(F instanceof g.sH)throw v=`GetOffline network manager error for playlist: ${F.message}`,s1(v,F),Error(v);s1("GetOffline fetch request error for playlist",F);throw Error("GetOffline fetch request error for playlist");}L=v.errorMetadata?.status;if(!v)throw s1("Network request failed for playlist"),Error("Network request failed for playlist");if(L!==void 0)qV(L,"playlist");else if(!v.playlists||!v.playlists.length)throw s1("No data for playlist"),
Error("No data for playlist");return v.playlists.map(F=>F.offlinePlaylistData)},wnw=async function(d,L,I,v){const F=await YL();
if(!F)return[];var R=[];v?.length?R=v:R=await $L(F,"mainPlaylistEntity");if(!R.length)return[];v=[];const D=Date.now()/1E3;for(const n of R){var O=n.downloadState?await iw(F,n.downloadState,"mainPlaylistDownloadStateEntity"):void 0,b=(R=n?.entityMetadata)&&R.nextAutoRefreshIntervalSeconds?Number(R.nextAutoRefreshIntervalSeconds):NaN;b=Number.isNaN(b)?d:b;var H=O?.lastSyncedTimestampMillis?Number(O?.lastSyncedTimestampMillis)/1E3:0;O=O?.addedTimestampMillis?Number(O?.addedTimestampMillis)/1E3:0;if(I||
!R||H+b<=D){b=[];if(n.videos?.length)for(const y of n.videos)H=JSON.parse(g.AS(y).entityId),H.videoId&&b.push(H.videoId);H="0";R&&(H=String(Number(R.offlineLastModifiedTimestampSeconds??0).toFixed()));v.push({playlistId:n.playlistId,videoIds:b,offlineLastModifiedTimestamp:H,autoSync:L,offlineDateAddedTimestamp:String(O.toFixed())})}}return v.length?await htc(v):[]},JZj=async function(){var d=await YL();
if(!d)return!1;d=await $L(d,"refresh");if(!d[0]?.refreshTime)return!1;d=Number(d[0].refreshTime);const L=Date.now()/1E3;return isFinite(d)&&L>=d},imj=async function(d,L){let I;
try{const v=await C9L(d,L);await etw(v);I=BbQ(v)}catch(v){s1("getAndProcessSmartDownloadsResponse request or processing error",v)}return I},$j1=async function(d,L,I,v){const F=await YL();
if(!F)return[];var R=[];v?.length?R=v:R=await $L(F,"musicPlaylist");if(!R.length)return[];v=[];const D=Date.now()/1E3;for(const H of R){var O=(R=H?.entityMetadata)&&R.nextAutoRefreshIntervalSeconds?Number(R.nextAutoRefreshIntervalSeconds):NaN;const n=Number.isNaN(O)?d:O;let y=O=0;var b="DOWNLOAD_SYNC_STATE_UNKNOWN";H.downloadMetadata&&(b=await iw(F,H.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),O=Number(b?.addedTimestampMillis??"0")/1E3,y=Number(b?.lastModifiedTimestampMillis??"0")/1E3,
b=b?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(I||b!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!R||Number(R.lastSyncedTimestampSeconds??0)+n<=D){R=[];if(H.tracks?.length)for(const r of H.tracks)R.push(g.AS(r).entityId);v.push({playlistId:H.playlistId,videoIds:R,offlineLastModifiedTimestamp:String(y.toFixed()),autoSync:L,offlineDateAddedTimestamp:String(O.toFixed())})}}return v.length?await htc(v):[]},C9L=async function(d,L){var I=g.Hl(),v=await YL();
let F;v&&(F=await f09(v));v=F;d={context:g.n2(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:d},offlineClientState:v,clientStateRequestData:{preferredFormatType:L}}}};L=g.yy(xj$);try{var R=await g.IY(I,d,L,void 0,{MQ:!0})}catch(D){if(D instanceof g.sH)throw R=`DPS network manager error for smart downloads: ${D.message}`,s1(R,D),Error(R);s1("DPS fetch request error for smart downloads",D);throw Error("DPS fetch request error for smart downloads");
}I=R.errorMetadata?.status;if(R)I!==void 0&&qV(I,"smart downloads");else throw s1("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return R},Syj=async function(d,L){var I=g.Hl();
d={context:g.n2(),videoPlaybackPositionEntities:d,lastSyncTimestampUsec:L};L=g.yy(Yyx);try{var v=await g.IY(I,d,L,void 0,{MQ:!0})}catch(F){if(F instanceof g.sH)throw v=`VPPS network manager error: ${F.message}`,s1(v,F),Error(v);s1("VPPS fetch request error",F);throw Error("VPPS fetch request error");}I=v.errorMetadata?.status;if(v)I!==void 0&&qV(I,"position sync");else throw s1("Network request failed for position sync"),Error("Network request failed for position sync");return v},qV=function(d,L){L=
L?` for ${L}`:"";
if(d===0)throw d=`Empty response body${L}`,s1(d),Error(d);d=`Response with error${L}`;s1(d);throw Error(d);},htc=async function(d){var L=g.Hl();
d=l0Q(d);const I=g.yy(Ujn);try{var v=await g.IY(L,d,I,void 0,{MQ:!0})}catch(F){if(F instanceof g.sH)throw v=`offlinePlaylistSyncCheck network manager error: ${F.message}`,s1(v,F),Error(v);s1("offlinePlaylistSyncCheck fetch request error",F);throw Error("offlinePlaylistSyncCheck fetch request error");}L=v.errorMetadata?.status;if(!v)throw s1("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(L!==void 0)qV(L,"playlist sync");else if(!v.offlinePlaylistSyncCheckDatas||
!v.offlinePlaylistSyncCheckDatas.length)throw s1("No data for playlist sync"),Error("No data for playlist sync");return v.offlinePlaylistSyncCheckDatas.map(F=>F.offlinePlaylistSyncCheckData)},s5U=async function(d,L){const I=new Map;
for(const v of L)I.set(v,await d.W(v));return I},EO=function(d,L,I,v,F,R){L=g.pw(L,I);
return{actionType:d,entityKey:L,actionMetadata:{...R,priority:v,retryScheduleIntervalsInSeconds:F}}},ZmQ=async function(d,L){var I=L.entityKey;
const v=g.U(L.actionMetadata,hB)?.isEnqueuedForExpiredStreamUrlRefetch;try{let R=void 0;R=await qy$(d,L);let D;try{{const O=g.U(L.actionMetadata,hB);var F=O?{maximumDownloadQuality:O.maximumDownloadQuality}:void 0}D=await Q_H(I,d.Hy,{isEnqueuedForExpiredStreamUrlRefetch:v,Ho:F,offlineSourceData:R})}catch(O){const b=gl(L)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";s1("PDE handleAdd error");return w7(L,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",b,"DOWNLOAD_STATE_FAILED")}await ltV(d,D,L);return w7(L,!0,D.orchestrationActions)}catch(R){return d="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",I="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",R instanceof g.Yx&&R.type==="QUOTA_EXCEEDED"&&(d="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",I="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),s1("PDE handleAdd error"),w7(L,!1,void 0,d,I,"DOWNLOAD_STATE_FAILED")}},
Q5j=async function(d,L){const I=L.entityKey,v=g.AS(I).entityId;
var F=await wl(d.O,{mode:"readonly",Bx:!0},y=>{const r=pS(y,I,"playbackData"),k=pS(y,g.pw(v,"offlineVideoPolicy"),"offlineVideoPolicy");y=pS(y,g.pw(v,"transfer"),"transfer");return g.lq.all([r,k,y])});
const [R,D,O]=F;if(!R||!D)return w7(L,!0);F=[];var b=R?.playerResponseJson?JSON.parse(R.playerResponseJson):null;if(O&&b){var H=NbV(d,b,O);F=await MK$(d,O)}F={lastPlayerResponseTimestampSeconds:R.playerResponseTimestamp,offlineToken:D.offlineToken,formatIds:F};b={};O?.maximumDownloadQuality&&(b.maximumDownloadQuality=O.maximumDownloadQuality);try{let y=void 0;y=await qy$(d,L);try{var n=await Q_H(I,d.Hy,{refreshData:F,Ho:b,offlineSourceData:y,mediaCapabilities:H})}catch(r){const k=gl(L)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":
"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";s1("PDE handleRefresh error");return w7(L,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",k,"DOWNLOAD_STATE_FAILED")}await ltV(d,n,L);return w7(L,!0,n.orchestrationActions)}catch(y){return d="PDE handleRefresh error",y instanceof Error&&(d=`PDE handleRefresh error: ${y.message}`),H="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",y instanceof g.Yx&&y.type===
"QUOTA_EXCEEDED"&&(H="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),s1(d),w7(L,!1,void 0,H,n,"DOWNLOAD_STATE_FAILED")}},qy$=async function(d,L){L=g.AS(L.entityKey).entityId;
L=g.pw(L,"videoDownloadContextEntity");d=await iw(d.O,L,"videoDownloadContextEntity");return d?.offlineModeType?{offlineModeType:d.offlineModeType}:void 0},w7=function(d,L,I,v,F,R){return new JB(L?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",gl(d),I,v,F,R)},ltV=async function(d,L,I){if(L.frameworkUpdates&&g.U(L.frameworkUpdates,WQ)){if(g.U(L.frameworkUpdates,WQ).mutations&&g.U(L.frameworkUpdates,WQ).mutations.length>0&&g.U(L.frameworkUpdates,WQ).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const v=g.AS(g.U(L.frameworkUpdates,WQ).mutations[0].entityKey).entityId,F=await tB(d.O,v),R=g.U(I.actionMetadata,hB)?.playlistId;
R&&(F.playlistId=R);F.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.EF(d.Hy)?await k9(v,d.O,I,d.G,F):g.fV(d.Hy)&&await AB(v,d.O,I,d.G)}await Sc(g.U(L.frameworkUpdates,WQ))}},NbV=function(d,L,I){L=OO(d.Hy,I.cotn,L);
I=g.Bg(L);return g.Vn7(L,I,d.Hy)},MK$=async function(d,L){const I=[];
if(d=await wl(d.O,{mode:"readonly",Bx:!0},v=>{const F=[],R=L.offlineVideoStreams;if(R)for(const D of R)F.push(pS(v,D,"offlineVideoStreams"));return g.lq.all(F)}))for(const v of d)if(v?.streamsProgress){d=v.streamsProgress;
for(let F=0;F<d.length;F++){const R=JSON.parse(d[F].formatStreamBytes);I.push({itag:R.itag,lmt:R.lastModified,xtags:R.xtags})}}return I},cZ$=async function(d,L){L=gl(L);
d=await $L(d.O,"videoPlaybackPositionEntity");if(d.length===0)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);try{const I=await CZ.getInstance();if(!I)throw Error("prefStorage is undefined");const v=(await I.get("psi"))?.Il??"0",F=await Syj(d,v),R={isPaused:F.watchHistoryPaused,Il:F.syncTimestampUsec};await I.set("psi",R);if(!R.isPaused){const D=g.U(F.frameworkUpdates,WQ);F.frameworkUpdates&&D&&await Sc(D)}}catch(I){return s1("PPE handleRefresh error: "+(I instanceof Error?I.message:
"unknown error")),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},ft1=async function(d,L){const I=gl(L),v=g.AS(L.entityKey).entityId;
try{const F=await CZ.getInstance();if(!F)throw Error("prefStorage is undefined");const R=await F.get("psi"),D=g.U(L.actionMetadata,VKj);if(R?.isPaused===!1&&D?.lastPlaybackPositionSeconds){const O={key:g.pw(v,"videoPlaybackPositionEntity"),videoId:v,lastPlaybackPositionSeconds:D.lastPlaybackPositionSeconds};await Jw(d.O,O,"videoPlaybackPositionEntity")}}catch(F){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
I)},Tbx=async function(d,L){const I=gl(L);
try{const v=g.AS(L.entityKey).entityId;if(v==="!*$_ALL_ENTITIES_!*$")await mIV(d.O);else{const F=g.pw(v,"videoPlaybackPositionEntity");await CS(d.O,F)}}catch(v){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)},io=async function(d){return UI1(d)},gTb=async function(d){return(await g.Bg$(d)).filter(L=>!!L.url).map(L=>
L.url)},$9=function(d,L){var I=g.ll(L);
if(I===1||I===0)return Promise.resolve();(I=d.player?.getVideoData().videoId===L?d.player:null)&&I.stopVideo();d.G=0;return io(L)},x9=function(d,L,I=!1,v=!0){L=typeof L==="string"?L:L.videoDetails.videoId;
if(g.ll(L)===2){var F=d.player?.getVideoData().videoId===L?d.player:null;F&&F.stopVideo();g.Z9(L,2);d.G=2;I?Xnb(d.O):v&&dX9(d.O)}},Idw=async function(d,L){const I=gl(L);
if(await iw(d.O,L.entityKey,"transfer"))return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);try{await LWw(d,L)}catch(v){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)},vbc=async function(d,L){const I=gl(L),v=await iw(d.O,L.entityKey,"transfer");
if(!v||v.transferState!=="TRANSFER_STATE_COMPLETE")return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);try{await LWw(d,L,!0)}catch(F){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)},FW1=async function(d,L){const I=gl(L),v=g.AS(L.entityKey).entityId,F=await wl(d.O,{mode:"readonly",
Bx:!0},O=>{const b=pS(O,L.entityKey,"transfer");O=pS(O,g.pw(v,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.lq.all([b,O])}),[R,
D]=F;if(!R||R.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);try{R.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await Jw(d.O,R,"transfer");const O=g.AS(R.key).entityId;Tn({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:O,pT:R,offlineModeType:D?.offlineModeType})}catch(O){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)},LWw=async function(d,L,I=!1){const v=g.U(L.actionMetadata,RPc),F=g.AS(L.entityKey).entityId,R=g.pw(F,"downloadStatusEntity");
var D=await wl(d.O,{mode:"readonly",Bx:!0},n=>{const y=pS(n,R,"downloadStatusEntity");n=pS(n,g.pw(F,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.lq.all([y,n])});
const [O,b]=D;D="TRANSFER_STATE_TRANSFER_IN_QUEUE";O?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(D="TRANSFER_STATE_PAUSED_BY_USER");const H={key:L.entityKey,transferState:D,cotn:g.jk(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:v?.maximumDownloadQuality,preferredAudioTrack:v?.preferredAudioTrack,transferRetryCount:0,isRefresh:I,hasLoggedFirstStarted:!1};await wl(d.O,{mode:"readwrite",Bx:!0},n=>{const y=[];I&&y.push(E1(n,g.pw(F,"offlineVideoStreams")));y.push(m2(n,H,"transfer"));
return g.lq.all(y)});
I&&await io(F);Tn({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:F,pT:H,offlineModeType:b?.offlineModeType})},OGL=function(d,L,I,v){if(!d.action.entityKey)throw Error("entityKey is missing.");
const {Hl:F,entityId:R}=g.AS(d.action.entityKey),D={entityType:F,entityId:R,offlineOrchestrationActionType:d.action.actionType,orchestrationAction:{orchestrationActionId:d.actionId}};L&&(D.offlineOrchestrationActionResult=L.status,D.isRetryable=I?!1:L.O,L.G&&(D.offlineOrchestrationFailureReason=DXw(L.G,D.isRetryable)));d.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(D.offlineModeType=d.action.actionMetadata.offlineLoggingData.offlineModeType);v&&(D.additionalOrchestrationActions=v.map(O=>
({orchestrationActionId:O.actionId})));
return D},DXw=function(d,L){return d!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||L?d==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&L?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":d:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},Y9=function(d,L){const I={offlineOrchestrationContext:OGL(d)};
L=cgQ(L,I);V8$(Nfc(),L,d.rootActionId)},Sw=function(d,L,I,v=[]){L={offlineOrchestrationContext:OGL(d,L,I,v)};
L=cgQ(3,L);V8$(Nfc(),L,d.rootActionId)},bGb=function(d,L){for(const I of L)Y9(I,1),d.actions.push(I);
d.actions.sort(d.O)},HG8=function(d,L){if(L)for(let I=0;I<d.actions.length;I++)if(L==="!*$_ALL_ENTITIES_!*$"&&d.actions[I].actionId!==L||L!=="!*$_ALL_ENTITIES_!*$"&&d.actions[I].rootActionId===L&&d.actions[I].actionId!==L)d.actions.splice(I,1),I--},nbL=function(d,L){for(const I of d.actions)if(I.actionId===L)return!0;
return!1},kY$=async function(d,L,I,v,F){d=new obL(d,L,I,v,F);
await yP$(d);rPQ(d);return d},yP$=async function(d){const L=await $L(d.W,"offlineOrchestrationActionWrapperEntity");
await UO(d,L)},rPQ=function(d){const L=d.O.actions[0];
return d.N?(L?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&d.N[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(d.L=!0),Promise.resolve()):KWU(d)},KWU=async function(d){if(d.N)throw Error("Already processing an action");
if(!d.X2()){var L=d.O.actions.shift();FU$(d.md,!L);if(L!==void 0){L.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&L.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&HG8(d.O,L.actionId);var I="";L.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&L.rootActionId===L.actionId&&(I=L.actionId);var v=[L];d.N=v;if(L=d.Wy[L.entityType]){for(const F of v)Y9(F,2);try{const F=await s5U(L,v.map(R=>R.action));
for(const R of v){const D=F.get(R.action);await ePx(d,R,D)}HG8(d.O,I)}catch(F){s1("Orchestration error",F);try{await WWj(d,v)}catch(R){s1("Orchestration retry error",R);for(const D of v)D.retryScheduleIndex<3&&bGb(d.O,[D])}}finally{d.N=void 0}}else d.N=void 0;await KWU(d)}}},ePx=async function(d,L,I){var v=L.retryScheduleIndex+2===3;
if(I.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var F=void 0;try{F=I.N?.map(R=>d.createAction(R,L))}catch(R){Sw(L,I,v);
cp(d.B,{entityKey:L.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});s1("Orchestration subactions creation error",R);return}Sw(L,I,v,F);if(F){const R=F.map(O=>oX(O));
let D=0;for(;D<F.length&&!d.L;)await wl(d.W,{mode:"readwrite",Bx:!0},O=>{const b=[];b.push(zn(O,R.slice(D,D+10),"offlineOrchestrationActionWrapperEntity"));return g.lq.all(b)}),D+=10;
if(d.L){d.L=!1;return}}I=oX(L);await CS(d.W,I.key);Y9(L,4)}else if(I.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(Sw(L,I,v),I.O&&L.retryScheduleIndex+1<3)await WWj(d,[L]);else{v={entityKey:L.action.entityKey,failureReason:I?.W?I.W:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};F=void 0;g.EF(d.Hy)?F="mainVideoDownloadStateEntity":g.fV(d.Hy)&&(F="musicTrackDownloadMetadataEntity");if(F&&I.downloadState){const R=g.AS(L.action.entityKey).entityId;await IX(R,F,d.W,I.downloadState)}cp(d.B,v);
I.downloadState==="DOWNLOAD_STATE_FAILED"&&d.Hy.C("html5_auto_retry_failed_pde_actions")||(s1("Orchestration result is not retryable, deleting action"),await CS(d.W,oX(L).key))}},WWj=async function(d,L){for(const I of L){const v=I.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let F=1;I.retryScheduleIndex<v.length&&(F=v[I.retryScheduleIndex]);I.O=F*1E3+Date.now();I.retryScheduleIndex++}await adH(d,L)},Btx=async function(d,L){return(await $L(d.W,"offlineOrchestrationActionWrapperEntity",L)).filter(CQb)},UO=async function(d,L){let I=[];
var v=Infinity;let F=4E3;for(const D of L){L=Number(D.enqueueTimeSec);const O=jN$(L);var R=D.retryScheduleIndex;R=R!=null&&R>0;O>0&&R?(v=Math.min(v,L),F=Math.min(O,F)):I.push(D)}isFinite(v)&&(!d.G.isActive()||v<d.j)&&(d.j=v,d.G.start(F));d.K.b5()||(v=I.length,I=I.filter(D=>!tI8.includes(D.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),v=I.length<v,!d.G.isActive()&&v&&d.G.start(1));
I.length>0&&APw(d,I);await rPQ(d)},jN$=function(d){d=d*1E3-Date.now();
return d>4E3?4E3:d},APw=function(d,L){L.length!==0&&L.forEach(I=>{I=nZ(I);
I.retryScheduleIndex<3&&bGb(d.O,[I])})},pY1=async function(d){var L=await Btx(d);
const I=[];for(const v of L)L=g.AS(v.key).entityId,nbL(d.O,L)||I.push(v);await UO(d,I)},adH=function(d,L){if(L.length===0)return Promise.resolve([]);
L=L.map(I=>oX(I));
return uw9(d.W,L)},PnH=async function(d,L){const I=L.videoId;
let v=!0;if(L.captionTracks.length){const F=bJ$(L);d.O=new g.BN(d.uU,L,F)}else if(L.CX)d.O=new g.tD(d.uU,L.CX,I,g.$OB(L),L.Cn,L.eventId),v=L.Cn;else return;return new Promise(F=>{d.O?.L({LG:async()=>{await d.LG(I,v);F()},
Cc:()=>{}})})},GYH=async function(d){d=await SZn(d);
return!!d&&d.length>0},u78=async function(d,L){if(L.length===0)return[];
const I=L.map(F=>g.pw(F,"transfer")),v=(await $L(d.O,"transfer",I)).filter(CQb).map(F=>g.AS(F.key).entityId);
d=L.filter(F=>v.indexOf(F)===-1);
if(d.length===0)return[];for(const F of d)await io(F);return d},Ebw=async function(d,L,I,v,F,R){let D="STREAM_TYPE_UNKNOWN";
I.video&&I.audio?(D="STREAM_TYPE_AUDIO_AND_VIDEO",s1("unexpected stream type")):I.video&&!I.audio?D="STREAM_TYPE_VIDEO":!I.video&&I.audio&&(D="STREAM_TYPE_AUDIO");const O=g.pw(L,"offlineVideoStreams"),b={numBytesDownloaded:F.toFixed(),numTotalBytes:R.toFixed(),streamType:D,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(v),itag:D==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(I.itag):void 0};await wl(d,{mode:"readwrite",Bx:!0},H=>{const n=pS(H,O,"offlineVideoStreams"),y=pS(H,
g.pw(L,"transfer"),"transfer");return g.lq.all([n,y]).then(([r,k])=>{if(!k)return E1(H,O).then(()=>{});
var W=mXV(r);r=zPU(r,v,b,O);const P=m2(H,r,"offlineVideoStreams");mXV(r)>W&&(k.lastProgressTimeMs=Date.now().toString());W=[P];k.offlineVideoStreams||(k.offlineVideoStreams=[]);k.offlineVideoStreams.indexOf(O)===-1&&(k.offlineVideoStreams.push(O),W.push(m2(H,k,"transfer")));return g.lq.all(W)})})},hP$=async function(d,L){L=g.pw(L,"offlineVideoStreams");
if((L=await iw(d,L,"offlineVideoStreams"))&&L.streamsProgress){for(const I of L.streamsProgress)I.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",I.numTotalBytes!==I.numBytesDownloaded&&(I.numBytesDownloaded=I.numTotalBytes);await Jw(d,L,"offlineVideoStreams")}},zPU=function(d,L,I,v){if(d&&d.streamsProgress){v=d;
a:{L=`${L.itag};${L.xtags}`;var F=d.streamsProgress;for(let R=0;R<F.length;R++){const D=JSON.parse(F[R].formatStreamBytes);if(`${D.itag};${D.xtags}`===L){F[R]=I;I=F;break a}}F.push(I);I=F}v.streamsProgress=I}else d={key:v,streamsProgress:[I]};return d},mXV=function(d){if(d?.streamsProgress){let L=0;
d=d.streamsProgress;for(let I=0;I<d.length;I++){const v=d[I];isNaN(Number(v.numBytesDownloaded))?s1("stream progress bytes number invalid"):L+=Number(v.numBytesDownloaded)}return L}return 0},Xnb=async function(d){if(d.O){const L=d.O;
d.N.stop();await sO(d,"TRANSFER_STATE_PAUSED_BY_USER");const I=L?.key?g.AS(L.key).entityId:"";I&&d.G&&await IX(I,d.G,d.W,"DOWNLOAD_STATE_PAUSED");const v=await qZ(d,I);Omw({videoId:I,pT:L,offlineModeType:v})}else lo(d,"onTransferPausedByUser");ZX(d);NZ(d)},dX9=async function(d){if(d.O){d.N.stop();
await sO(d,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var L=d.O;(L=L?.key?g.AS(L.key).entityId:"")&&d.G&&await IX(L,d.G,d.W,"DOWNLOAD_STATE_PAUSED");ZX(d)}else lo(d,"onTransferPausedByNetwork")},MZ=async function(d){if(d.O){d.N.start(108E5);
await sO(d,"TRANSFER_STATE_TRANSFERRING");var L=d.O;(L=L?.key?g.AS(L.key).entityId:"")&&d.G&&await IX(L,d.G,d.W,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else lo(d,"onTransferStart")},wY1=async function(d,L,I){if(d.O){d.O.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await MZ(d);
var v=Date.now();v-d.sU>1E3&&(d.sU=v,await Ebw(d.W,I.videoId,I.W,I.Na,I.bytesDownloaded,I.O),!d.U||d.U&&v-d.md>d.K1)&&(d.md=v,v=await qZ(d,L),Djw({videoId:L,pT:d.O,offlineModeType:v},I.bytesDownloaded,I.O));d.N.start(108E5)}else lo(d,`onTransferProgress: ${L}`)},Cnx=async function(d){if(d.O){var L=d.O;
d.N.stop();if(L&&d.L){var I=OO(d.api.V(),L.cotn,d.L);await JP9(d,I)}await sO(d,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(I=L?.key?g.AS(L.key).entityId:"")&&d.G&&await IX(I,d.G,d.W,"DOWNLOAD_STATE_COMPLETE");await hP$(d.W,I);var v=await qZ(d,I);Tn({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:I,pT:L,offlineModeType:v});ZX(d);NZ(d)}else lo(d,"onTransferComplete")},iG$=async function(d){await xI1();
d=d.N0;var L=g.qf();L=Object.keys(L);await u78(d,L)},YV$=async function(d){d=(await $L(d.W,"transfer")).filter($XH).sort(xXb);
return d.length===0?void 0:d[0]},sN1=async function(d,L){if(!d.j){d.j=!0;
d.O=L;var I=g.AS(d.O.key).entityId;if(d.O.transferState==="TRANSFER_STATE_TRANSFERRING"){var v=await qZ(d,I);Tn({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:I,pT:d.O,offlineModeType:v})}else d.O.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||d.O.transferRetryCount||d.O.hasLoggedFirstStarted||(v=await qZ(d,I),d.O.hasLoggedFirstStarted=!0,await SVH(d),Djw({videoId:I,pT:d.O,offlineModeType:v},void 0,void 0,!0));await MZ(d);I=null;try{I=await UX1(d,
L),d.L=I}catch(F){s1("error getting player response",F,L.cotn);await d.ev("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}v=OO(d.api.V(),L.cotn,I);await JP9(d,v);v.OY=await gTb(v.videoId);I=d.B;L=L.maximumDownloadQuality;v.getPlayerResponse();g.Z9(v.videoId,2);I.G=2;I.W=!1;I.player?.dispose();I.player=I.api.P6(v);I.player.T7({localmediachange:I.qO,signatureexpired:I.BK,statechange:I.N},I);I.C("html5_generate_content_po_token")&&I.player.jh();L=I.ge(L);I.player.P4(g.LC(L,L,!0,"m"),!1);I.player.j7(!1);
d.N.start(108E5)}},ZX=function(d){d.O=void 0;
d.L=void 0;d.N.stop()},NZ=async function(d,L=!1){if(d.O)throw Error("Already downloading a video");
d.md=0;d.j=!1;const I=await YV$(d);RtQ(d.bU,!I);I&&d.K.b5()?(L&&await new Promise(v=>{g.l$(v,1E3)}),await sN1(d,I)):!I&&d.O&&ZX(d)},qZ=async function(d,L){return(await iw(d.W,g.pw(L,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},qV1=async function(d){d.L&&(await $9(d.B,d.L.videoDetails.videoId),ZX(d))},JP9=async function(d,L){try{(L.captionTracks.length||L.CX)&&!await GYH(L.videoId)&&await PnH(d.M0,L)}catch(I){s1("Caption downloading error",I,L.cotn)}},SVH=
async function(d,L){if(d.O){var I=d.O;
await wl(d.W,{mode:"readwrite",Bx:!0},v=>{const F=[m2(v,I,"transfer")];L&&F.push(L(v));return g.lq.all(F)})}},UX1=async function(d,L){L=g.AS(L.key).entityId;
L=g.pw(L,"playbackData");d=await iw(d.W,L,"playbackData");if(d?.playerResponseJson)return JSON.parse(d.playerResponseJson);throw Error("No PlayerResponse found");},sO=async function(d,L,I,v){if(d.O){d.O.transferState=L;
d.O.failureReason=v;try{await SVH(d,F=>I?Pp(F,"offlineVideoStreams",d.O.offlineVideoStreams).then(R=>{for(const D of R)if(D&&D.streamsProgress)for(const O of D.streamsProgress)O.streamState=I;return zn(F,R.filter(D=>!!D),"offlineVideoStreams")}):g.lq.resolve(void 0))}catch(F){F instanceof g.Yx&&F.type==="QUOTA_EXCEEDED"&&await d.ev("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else lo(d,`saveTransferState: ${L}`)},lo=function(d,L){d.api.GS("woffle",{mcte:L});
s1("missing current transfer entity.")},ldV=function(d){const L=(d.O.transferRetryCount||0)<3;
L&&(d=d.O,d.transferRetryCount=(d.transferRetryCount||0)+1);return L},ZG1=async function(d,L="TRANSFER_FAILURE_REASON_UNKNOWN"){d.O||lo(d,`setTransferToFailed: ${L}`);
var I="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";L==="TRANSFER_FAILURE_REASON_NETWORK"?I="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":L==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(I="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await sO(d,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",L);cp(d.Z,{entityKey:d.O?.key,failureReason:I});I=d.O?g.AS(d.O.key).entityId:"";const v=await qZ(d,I);d={videoId:I,pT:d.O,offlineModeType:v};I={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};L&&(I.transferFailureReason=L,I.failureReason=bmQ(L));Tn(I,d)},$XH=function(d){return Qv[d.transferState]!==void 0},xXb=function(d,L){const I=Qv[d.transferState],v=Qv[L.transferState];
return I!==v?I-v:Number(d.enqueuedTimestampMs)-Number(L.enqueuedTimestampMs)},Nt9=async function(d){g.cg(d.api,"onOrchestrationBecameLeader");
await d.Sz()},cPV=async function(d){const L=await YL();
if(L){d.W=new MIL(L,d.api,d.G,d.O);var I=d.K(L);d.j=await kY$(L,I,d.G,d.O,d.Hy);await QNb(d)}else s1("PES is undefined")},QNb=async function(d){if(d.W){d.W.O||await NZ(d.W);
d.Hy.C("woffle_enable_main_downloads_library")&&await d.L1();d.Hy.C("html5_offline_playback_position_sync")&&(await d.sU(),await d.Bv(864E5));await d.refreshAllStaleEntities(43200,!0);await d.U();d.Hy.C("html5_retry_downloads_for_expiration")&&await d.Y9();d.md=g.Zc(()=>{d.refreshAllStaleEntities(43200,!0);d.U()},9E5);
g.pX(g.GW(),()=>d.At());
var L=await YL();await LUj(L);vT1(d.G)}else s1("transferManager is undefined")},VI$=async function(){const d=await YL();
if(!d)return[];const L=Date.now()/1E3,I=await $L(d,"offlineVideoPolicy");for(const v of I)v.expirationTimestamp&&Number(v.expirationTimestamp)<L&&(v.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",v.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await Jw(d,v,"offlineVideoPolicy"));return I.map(v=>v.key)},cQ=async function(d,L,I,v,F){var R=await YL();
if(!R)return[];L=L.map(D=>{var O=g.pw(D,I);O={actionType:v,entityKey:O,actionMetadata:{...bo(),...F}};v!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(O.actionMetadata.priority=0);D=new HQ(I,D,O);return oX(D)});
R=uw9(R,L);Itx(d.G);return R},fdV=async function(d,L,I,v){const F=[];
for(const R of L)if(!R.upToDate&&(!I||R.shouldAutoSyncMetadata)&&R.playlistId){L={};switch(v){case "mainPlaylistEntity":L={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:R.checkInSeconds,autoSync:I}};break;case "musicPlaylist":L={musicPlaylistEntityActionMetadata:{autoSync:I}}}(L=await cQ(d,[R.playlistId],v,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",L))&&F.push(...L)}return F},Ttc=async function(d,L){if(L.length){const I=bo();
g.sG(I,hB,{isEnqueuedForExpiredStreamUrlRefetch:!0});d.api.GS("qrd",{v:L.length});return cQ(d,L,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",I)}return[]},XYQ=async function(d,L){const I=gl(L);
var v=g.AS(L.entityKey).entityId;let F=[];try{F=await gbU(d,v),d.Hy.C("woffle_enable_main_downloads_library")&&F?.length&&await BQ(d.O,[L.entityKey])}catch(D){return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",D instanceof g.Yx&&D.type==="QUOTA_EXCEEDED"?(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):s1("Playlist add error"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
I,void 0,L,v)}const R=[];d.Hy.C("html5_offline_prevent_redownload_downloaded_video")&&(F=await DX(d.O,"mainVideoEntity",F));if(F?.length)for(const D of F)d=D.offlineVideoData,d?.videoId&&R.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",d.videoId,"mainVideoEntity",Number(L.actionMetadata?.priority||0)+1,Vv,fZ(L,d,v)));return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,R)},LdL=async function(d,L){const I=gl(L);
var v=L.entityKey,F=g.AS(v).entityId,R=[],D=!1;F==="!*$_ALL_ENTITIES_!*$"?(D=!0,R=await $L(d.O,"mainPlaylistEntity")):(v=await iw(d.O,v,"mainPlaylistEntity"))&&R.push(v);if(!R?.length)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);var O=g.U(L.actionMetadata,dtH);v=O?.nextAutoRefreshIntervalSeconds;const b=O?.autoSync;let H=[],n=!0;O=!0;let y=!1;if(D||b!==!1){try{H=await wnw(0,!!b,!0,R)}catch(P){P instanceof Error&&P.message==="No data"?F==="!*$_ALL_ENTITIES_!*$"?await ew(d.O,L,d.G,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await KZ(F,d.O,L,d.G):P instanceof Error&&P.message==="Empty response body"&&s1(P.message)}if(!H.length||!D&&H[0].playlistId!==F)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)}if(D){L=[];for(var r of H)r.upToDate||b&&!r.shouldAutoSyncMetadata||!r.playlistId||L.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",r.playlistId,"mainPlaylistEntity",0,Vv,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:r.checkInSeconds,autoSync:b}}));
return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,L)}H.length&&(r=H[0],y=!!r.upToDate,b&&(n=r.shouldAutoSyncMetadata??!0,O=r.shouldAutoSyncVideos??!0,r.checkInSeconds&&(v=r.checkInSeconds)));if(y||!n)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);r=[];R=R[0];D=R.downloadState?await iw(d.O,R.downloadState,"mainPlaylistDownloadStateEntity"):void 0;D=D?.addedTimestampMillis?String(D.addedTimestampMillis):void 0;try{r=await gbU(d,F,D,v)}catch(P){if(P instanceof Error&&P.message===
"No data for playlist")await KZ(F,d.O,L,d.G);else if(P instanceof Error&&P.message==="Empty response body for playlist")s1(P.message);else return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",P instanceof g.Yx&&P.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,L,F)}if(!O)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
I);d=[];v=new Map;if(r?.length)for(var k of r)O=k.offlineVideoData,O?.videoId&&v.set(O.videoId,O);k=new Map;O=[];if(R?.videos?.length)for(var W of R.videos)if(R=JSON.parse(g.AS(W).entityId).videoId)v.has(R)?(k.set(R,v.get(R)),v.delete(R)):O.push(R);W=Number(L.actionMetadata?.priority||0)+1;for(const [P,z]of v.entries())d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",P,"mainVideoEntity",W,Vv,fZ(L,z,F)));for(const [P,z]of k.entries())d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",P,"mainVideoEntity",
W,Vv,fZ(L,z,F)));for(const P of O)d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",P,"mainVideoEntity",0,Vv,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:F}}));return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,d)},I$n=async function(d,L){const I=gl(L);
try{const v=g.AS(L.entityKey).entityId;v==="!*$_ALL_ENTITIES_!*$"?await ew(d.O,L,d.G,L.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await KZ(v,d.O,L,d.G),d.Hy.C("woffle_enable_main_downloads_library")&&await jw(d.O,L.entityKey))}catch(v){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
I)},gbU=async function(d,L,I,v){L=await zT([L]);
const {mainPlaylistEntity:F,GE:R}=await v4L(d,L[0],I,v);d=rZQ(F,R?.avatar);try{await r7(d)}catch(D){D instanceof Error&&D.message==="Failed to fetch"&&s1(D.message)}return L[0].videos},fZ=function(d,L,I){L={offlineVideoData:L,
playlistId:I};if(d=g.U(d.actionMetadata,dtH))L.maximumDownloadQuality=d.maximumDownloadQuality;return{mainVideoEntityActionMetadata:L}},v4L=async function(d,L,I,v){const F=Date.now().toString();
I||(I=F);var R=L.videos;const D=L.playlistId,O=[],b=[];if(R)for(const r of R){R=r.offlineVideoData;if(!R||!R.videoId)throw s1("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");R=R.videoId;R={id:g.pw(JSON.stringify({videoId:R,playlistId:D}),"mainPlaylistVideoEntity"),video:g.pw(R,"mainVideoEntity")};O.push(R);b.push(R.id)}let H;const n={key:g.pw(D,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:I,lastSyncedTimestampMillis:F},y={key:g.pw(D,"mainPlaylistEntity"),
playlistId:D,videos:b,title:L.title,thumbnailStyleData:Fd1(L),visibility:RsL(L),downloadState:n.key};L.channel&&(I=L.channel.offlineChannelData,H=Dtb(g.pw(D,"ytMainChannelEntity"),I),y.channelOwner=H.id);y?.entityMetadata?(y.entityMetadata.offlineLastModifiedTimestampSeconds=L.lastModifiedTimestamp,v&&(y.entityMetadata.nextAutoRefreshIntervalSeconds=String(v))):y&&(y.entityMetadata={nextAutoRefreshIntervalSeconds:v?String(v):void 0,offlineLastModifiedTimestampSeconds:L.lastModifiedTimestamp});try{await wl(d.O,
{mode:"readwrite",Bx:!0},r=>{var k=m2(r,y,"mainPlaylistEntity");const W=m2(r,n,"mainPlaylistDownloadStateEntity");k=[k,W];for(const P of O)k.push(m2(r,P,"mainPlaylistVideoEntity"));H&&k.push(m2(r,H,"ytMainChannelEntity"));return g.lq.all(k)})}catch(r){throw s1("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:y,GE:H,dk1:O}},Fd1=function(d){const L=[];
var I=d.videos;I&&I.length>0&&L.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:I[0].offlineVideoData.thumbnail}}});if((d=d.additionalMetadadatas)&&d.length>0)for(const v of d)switch(d=v.offlineBundleItemPlaylistData,I={collageThumbnail:{coverThumbnail:d?.coverThumbnail}},d?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":L.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:I});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":L.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:I});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":L.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:I});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":L.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:I})}return L},RsL=function(d){switch(d.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},Dtb=function(d,L){return{id:d,
channelId:L.channelId,title:L.title,avatar:L.thumbnail}},HRj=async function(d,L){const I=gl(L);
var v=g.AS(L.entityKey).entityId;const F=g.U(L.actionMetadata,TT),R=!F?.playlistId;try{await ORU(d,v,void 0,F?.offlineVideoData,R)}catch(D){return v="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",D instanceof g.Yx&&D.type==="QUOTA_EXCEEDED"&&(v="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,v,L)}d=Number(L.actionMetadata?.priority||
0)+1;L=(L=g.U(L.actionMetadata,TT))?{playbackDataActionMetadata:{maximumDownloadQuality:L.maximumDownloadQuality}}:void 0;v=EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",v,"playbackData",d,bRn,L);return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,[v])},n48=async function(d,L){const I=gl(L),v=g.AS(L.entityKey).entityId;
var F=await iw(d.O,L.entityKey,"mainVideoEntity"),R=F?await iw(d.O,F.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!F||!R)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);let D;try{await ORU(d,v,R.addedTimestampMillis,g.U(L.actionMetadata,TT)?.offlineVideoData),F=1,F=Number(L.actionMetadata?.priority||0)+1,D=EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",v,"playbackData",F,bRn)}catch(O){if(O instanceof Error&&O.message==="No data"){F=await tB(d.O,v);if(R=g.U(L.actionMetadata,
TT)?.playlistId)F.playlistId=R;F.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await k9(v,d.O,L,d.G,F)}else if(O instanceof Error&&O.message==="Empty response body")s1(O.message);else return d="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",O instanceof g.Yx&&O.type==="QUOTA_EXCEEDED"&&(d="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
I,void 0,d,L)}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,D?[D]:void 0)},o4$=async function(d,L){const I=gl(L);
try{const v=g.AS(L.entityKey).entityId;if(v==="!*$_ALL_ENTITIES_!*$")await ew(d.O,L,d.G,L.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const F=await tB(d.O,v),R=g.U(L.actionMetadata,TT)?.playlistId;R&&(F.playlistId=R);F.offlineDeleteReason=L.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await k9(v,d.O,L,d.G,F);d.Hy.C("woffle_enable_main_downloads_library")&&await jw(d.O,L.entityKey)}}catch(v){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)},ORU=async function(d,L,I,v,F){v||(v=(await ET$([L]))[0]);
const {mainVideoEntity:R,channelEntity:D}=await ykj(d,v,I,F);try{const O=RX(R.thumbnail),b=RX(D.avatar);await r7(O.concat(b))}catch(O){O instanceof Error&&O.message==="Failed to fetch"&&s1(O.message)}},ykj=async function(d,L,I,v){I||(I=Date.now().toString());
const F=L.channel?.offlineChannelData,R={id:g.pw(L.videoId,"ytMainChannelEntity"),channelId:F.channelId,title:F.title,avatar:F.thumbnail},D={key:g.pw(L.videoId,"mainVideoDownloadStateEntity"),playbackData:g.pw(L.videoId,"playbackData"),addedTimestampMillis:I,videoDownloadContextEntity:g.pw(L.videoId,"videoDownloadContextEntity")},O={key:g.pw(L.videoId,"videoPlaybackPositionEntity"),videoId:L.videoId,lastPlaybackPositionSeconds:"0"};let b;d.Hy.C("html5_offline_playback_position_sync")&&(b={playbackPosition:O.key});
I=g.pw(L.videoId,"mainVideoEntity");const H={key:I,videoId:L.videoId,title:L.title,thumbnail:L.thumbnail,localizedStrings:{viewCount:L.shortViewCountText},userState:b,lengthSeconds:L.lengthSeconds?Number(L.lengthSeconds):void 0,publishedTimestampMillis:L.publishedTimestamp?(Number(L.publishedTimestamp)*1E3).toString():void 0,formattedDescription:L.description,owner:R.id,downloadState:D.key};let n,y;d.Hy.C("woffle_enable_main_downloads_library")&&v&&(v=await tK9(d.O,[I]))&&(n=v.mainDownloadsLibraryEntity,
y=v.mainDownloadsListEntity);let r;r={key:g.pw(L.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.sG(D,nTn,r);await wl(d.O,{mode:"readwrite",Bx:!0},k=>{var W=m2(k,R,"ytMainChannelEntity"),P=m2(k,D,"mainVideoDownloadStateEntity");const z=m2(k,H,"mainVideoEntity");W=[W,P,z];d.Hy.C("html5_offline_playback_position_sync")&&(P=m2(k,O,"videoPlaybackPositionEntity"),W.push(P));n&&(P=m2(k,n,"mainDownloadsLibraryEntity"),W.push(P));y&&(P=m2(k,y,"mainDownloadsListEntity"),
W.push(P));r&&(k=m2(k,r,"downloadStatusEntity"),W.push(k));return g.lq.all(W)});
return{mainVideoEntity:H,channelEntity:R}},kxQ=async function(d,L){const I=gl(L),v=[];
var F=await CZ.getInstance();let R,D;F&&(R=await F.get("sdois"),D=await F?.get("lmqf"));try{if(R===void 0)throw Error("prefStorage or opt-in state is undefined");F=[];R||(F=await j5x(d.O),F.reverse());if(F.length)for(const H of F){if(!H)continue;const n=g.AS(H).entityId,y=await tB(d.O,n);y.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await k9(n,d.O,{entityKey:H,actionType:L.actionType},d.G,y)}const O=await C9L(R,D??"SD");await etw(O);const b=BbQ(O);d.Hy.C("woffle_enable_main_downloads_library")&&
(R||await jw(d.O,aX),await BQ(d.O,[aX]));if(b?.length)for(const H of b){const n=H.actionType,y=H.entityKey,r=H.actionMetadata;if(n&&y&&r&&!g.U(r,rk$)){n==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(r.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const k=g.U(H.actionMetadata,TT);k&&(k.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",H.actionMetadata={...H.actionMetadata,mainVideoEntityActionMetadata:k});v.push(H)}}}catch(O){return d="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
L="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",O instanceof g.Yx&&O.type==="QUOTA_EXCEEDED"&&(d="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,d,L)}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,v)},Kdw=async function(d,L=43200,I=!0){if(!d.B.b5())return[];
let v=[];try{v=await wnw(L,I,!1)}catch(F){F instanceof Error&&F.message==="No data"||F instanceof Error&&F.message==="Empty response body"&&s1(F.message)}return fdV(d,v,I,"mainPlaylistEntity")},es$=async function(d,L,I,v=!1){let F=[];
if(!await JZj()&&!v)return[];I=await imj(L,I);if(!I?.length)return[];L={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const D of I){I=D.actionType;var R=D.entityKey;v=D.actionMetadata;I&&R&&v&&!g.U(v,rk$)&&(I==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(v.offlineLoggingData=L),{entityId:R}=g.AS(R),I=await cQ(d,[R],"mainVideoEntity",I,v),F=F.concat(I))}return F},a$x=async function(d,L){const I=gl(L);
var v=g.AS(L.entityKey).entityId;let F=[];try{F=await Wdc(d,v),F?.length&&await GT(d.O,L.entityKey)}catch(D){return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",D instanceof g.Yx&&D.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,L,v)}const R=[];F=await DX(d.O,"musicTrack",F);if(F.length)for(const D of F)d=
D.offlineVideoData,d?.videoId&&R.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",d.videoId,"musicTrack",Number(L.actionMetadata?.priority||0)+1,g7,m4(L,d,v)));return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,R)},B6Q=async function(d,L){const I=gl(L);
var v=L.entityKey,F=g.AS(v).entityId,R=[],D=!1;F==="!*$_ALL_ENTITIES_!*$"?(D=!0,R=await $L(d.O,"musicAlbumRelease")):(v=await iw(d.O,v,"musicAlbumRelease"))&&R.push(v);if(!R?.length)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);if(D){L=[];for(var O of R){var b=g.AS(O.id).entityId;L.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",b,"musicAlbumRelease",0,g7))}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,L)}O=[];R=R[0];D=void 0;R.downloadMetadata&&(D=await iw(d.O,
R.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),D=Number(D?.addedTimestampMillis??"0")/1E3);try{O=await Wdc(d,F,D?.toString())}catch(y){if(y instanceof Error&&y.message==="No data")await pZ(F,"musicAlbumRelease",d.O,L,d.G);else if(y instanceof Error&&y.message==="Empty response body")s1(y.message);else return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",b="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",y instanceof g.Yx&&y.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
b="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,L,b)}d=[];F=new Map;if(O?.length)for(var H of O)O=H.offlineVideoData,O?.videoId&&F.set(O.videoId,O);H=new Map;O=[];if(R?.tracks?.length)for(var n of R.tracks)if(R=g.AS(n).entityId)F.has(R)?(H.set(R,F.get(R)),F.delete(R)):O.push(R);n=Number(L.actionMetadata?.priority||0)+1;for(const [y,r]of F.entries())d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",y,"musicTrack",n,g7,m4(L,r)));for(const [y,
r]of H.entries())d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",y,"musicTrack",n,g7,m4(L,r)));for(b of O)d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",b,"musicTrack",0,g7));return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,d)},jQV=async function(d,L){const I=gl(L);
try{const v=g.AS(L.entityKey).entityId;v==="!*$_ALL_ENTITIES_!*$"?await PQ(d.O,L,d.G):(await pZ(v,"musicAlbumRelease",d.O,L,d.G),await uo(d.O,L.entityKey))}catch(v){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)},Wdc=async function(d,L,I){L=await zT([L]);
d=await t6b(d,L[0],I);d=RX(d.thumbnailDetails);await r7(d);return L[0].videos},t6b=async function(d,L,I){var v=L.additionalMetadadatas;
let F=void 0;if(v&&v.length>0)for(var R of v)if(R.offlineMusicPlaylistData){F=R.offlineMusicPlaylistData;break}v=L.playlistId;const {Cd:D,Kd:O}=uZV(L);I=I?(Number(I)*1E3).toString():Date.now().toString();R=L.lastModifiedTimestamp?(Number(L.lastModifiedTimestamp)*1E3).toString():"0";const b={id:g.pw(v,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:O,lastModifiedTimestampMillis:R,addedTimestampMillis:I,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},H={id:g.pw(v,"musicAlbumRelease"),
title:L.title,audioPlaylistId:v,trackCount:L.totalVideoCount,tracks:D,downloadMetadata:b.id};F&&(H.thumbnailDetails=F.albumHqThumbnail??F.albumArtistThumbnail,H.artistDisplayName=F.albumArtistDisplayName,H.releaseDate=F.albumReleaseDate,H.contentRating={explicitType:F.albumReleaseExplicitType},H.releaseType=F.albumReleaseType);await wl(d.O,{mode:"readwrite",Bx:!0},n=>{const y=m2(n,H,"musicAlbumRelease");n=m2(n,b,"musicAlbumReleaseDownloadMetadataEntity");return g.lq.all([y,n])});
return H},pq8=async function(d,L){const I=gl(L);
var v=g.AS(L.entityKey).entityId;let F=[];try{F=await Ak9(d,v),F?.length&&await GT(d.O,L.entityKey)}catch(D){return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",D instanceof g.Yx&&D.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,L,v)}const R=[];F=await DX(d.O,"musicTrack",F);if(F.length)for(const D of F)d=
D.offlineVideoData,d?.videoId&&R.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",d.videoId,"musicTrack",Number(L.actionMetadata?.priority||0)+1,XD,m4(L,d,v)));return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,R)},PZQ=async function(d,L){const I=gl(L);
var v=L.entityKey,F=g.AS(v).entityId,R=[],D=!1;F==="!*$_ALL_ENTITIES_!*$"?(D=!0,R=await $L(d.O,"musicPlaylist")):(v=await iw(d.O,v,"musicPlaylist"))&&R.push(v);if(!R?.length)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);const O=g.U(L.actionMetadata,mj8)?.autoSync;let b=[],H=!0;v=!0;let n=!1;var y=void 0;if(D||O!==!1){try{b=await $j1(0,!!O,!0,R)}catch(z){z instanceof Error&&z.message==="No data"?F==="!*$_ALL_ENTITIES_!*$"?await PQ(d.O,L,d.G):await pZ(F,"musicPlaylist",d.O,L,d.G):z instanceof
Error&&z.message==="Empty response body"&&s1(z.message)}if(!b.length||!D&&b[0].playlistId!==F)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)}if(D){L=[];for(var r of b)r.upToDate||O&&!r.shouldAutoSyncMetadata||!r.playlistId||L.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",r.playlistId,"musicPlaylist",0,XD,{musicPlaylistEntityActionMetadata:{autoSync:O}}));return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,L)}b.length&&(r=b[0],n=!!r.upToDate,O&&(H=r.shouldAutoSyncMetadata??
!0,v=r.shouldAutoSyncVideos??!0,r.checkInSeconds&&(y=r.checkInSeconds)));if(n||!H)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);r=[];R=R[0];D=void 0;R.downloadMetadata&&(D=await iw(d.O,R.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),D=Number(D?.addedTimestampMillis??"0")/1E3);try{r=await Ak9(d,F,D?.toString(),y)}catch(z){if(z instanceof Error&&z.message==="No data")await pZ(F,"musicPlaylist",d.O,L,d.G);else if(z instanceof Error&&z.message==="Empty response body")s1(z.message);
else{L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var k="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";z instanceof g.Yx&&z.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",k="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,L,k)}}if(!v)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);d=[];F=new Map;if(r?.length)for(var W of r)v=W.offlineVideoData,v?.videoId&&
F.set(v.videoId,v);W=new Map;v=[];if(R?.tracks?.length)for(var P of R.tracks)if(y=g.AS(P).entityId)F.has(y)?(W.set(y,F.get(y)),F.delete(y)):v.push(y);P=Number(L.actionMetadata?.priority||0)+1;for(const [z,w]of F.entries())d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",z,"musicTrack",P,XD,m4(L,w)));for(const [z,w]of W.entries())d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",z,"musicTrack",P,XD,m4(L,w)));for(k of v)d.push(EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",k,"musicTrack",0,XD));
return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,d)},Gx8=async function(d,L){const I=gl(L);
try{const v=g.AS(L.entityKey).entityId;v==="!*$_ALL_ENTITIES_!*$"?await PQ(d.O,L,d.G):(await pZ(v,"musicPlaylist",d.O,L,d.G),await uo(d.O,L.entityKey))}catch(v){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)},Ak9=async function(d,L,I,v){L=await zT([L]);
d=await uaU(d,L[0],I,v);d=RX(d.thumbnailDetails);await r7(d);return L[0].videos},uaU=async function(d,L,I,v){const F=L.playlistId,{Cd:R,
Kd:D}=uZV(L);I=I?(Number(I)*1E3).toString():Date.now().toString();const O=L.lastModifiedTimestamp?(Number(L.lastModifiedTimestamp)*1E3).toString():"0",b={id:g.pw(F,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:D,lastModifiedTimestampMillis:O,addedTimestampMillis:I,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},H={id:g.pw(F,"musicPlaylist"),title:L.title,playlistId:F,thumbnailDetails:L.thumbnail,visibility:mtL(L),trackCount:L.totalVideoCount,tracks:R,downloadMetadata:b.id};v&&(H?.entityMetadata?
H.entityMetadata.nextAutoRefreshIntervalSeconds=String(v):H&&(H.entityMetadata={nextAutoRefreshIntervalSeconds:String(v)}));await wl(d.O,{mode:"readwrite",Bx:!0},n=>{const y=m2(n,H,"musicPlaylist");n=m2(n,b,"musicPlaylistDownloadMetadataEntity");return g.lq.all([y,n])});
return H},mtL=function(d){switch(d.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},hsn=async function(d,L){const I=gl(L);
var v=g.AS(L.entityKey).entityId;const F=g.U(L.actionMetadata,d8);try{await zsH(d,v,void 0,F?.track,F?.albumRelease),F?.playlistId||await GT(d.O,L.entityKey)}catch(R){return L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",R instanceof g.Yx&&R.type==="QUOTA_EXCEEDED"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,
void 0,L,v)}d=(d=g.U(L.actionMetadata,d8))?{playbackDataActionMetadata:{maximumDownloadQuality:d.maximumDownloadQuality}}:void 0;L=EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",v,"playbackData",Number(L.actionMetadata?.priority||0)+1,E4V,d);return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,[L])},wqL=async function(d,L){const I=gl(L),v=g.AS(L.entityKey).entityId;
var F=await iw(d.O,L.entityKey,"musicTrack");const R=F?await iw(d.O,F.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!F||!R)return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I);let D;F=g.U(L.actionMetadata,d8);try{await zsH(d,v,R.addedTimestampMillis,F?.track,F?.albumRelease),D=EO("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",v,"playbackData",Number(L.actionMetadata?.priority||0)+1,E4V)}catch(O){if(O instanceof Error&&O.message==="No data")await AB(v,d.O,L,d.G);else if(O instanceof
Error&&O.message==="Empty response body")s1(O.message);else return d="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",O instanceof g.Yx&&O.type==="QUOTA_EXCEEDED"&&(d="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,d,L)}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I,D?[D]:void 0)},Jkb=async function(d,
L){const I=gl(L);
try{const v=g.AS(L.entityKey).entityId;v==="!*$_ALL_ENTITIES_!*$"?await PQ(d.O,L,d.G):(await AB(v,d.O,L,d.G),await uo(d.O,L.entityKey))}catch(v){return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",I,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new JB("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",I)},zsH=async function(d,L,I,v,F){v||(v=(await ET$([L]))[0],v=G5Q(v));
const {musicTrackEntity:R,qg:D}=await CZQ(d,v,L,F,I);d=RX(R.thumbnailDetails);L=[];D&&(L=RX(D.thumbnailDetails));await r7(d.concat(L))},CZQ=async function(d,L,I,v,F){F||(F=Date.now().toString());
const R={id:g.pw(I,"musicTrackDownloadMetadataEntity"),playbackData:g.pw(I,"playbackData"),addedTimestampMillis:F,videoDownloadContextEntity:g.pw(I,"videoDownloadContextEntity")};v&&(L.albumRelease=v.id);await wl(d.O,{mode:"readwrite",Bx:!0},D=>{const O=[];var b=m2(D,R,"musicTrackDownloadMetadataEntity");O.push(b);b=m2(D,L,"musicTrack");O.push(b);v&&(D=m2(D,v,"musicAlbumRelease"),O.push(D));return g.lq.all(O)});
await IX(I,"musicTrackDownloadMetadataEntity",d.O,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:L,qg:v}},iR1=async function(d,L=43200,I=!0){if(!d.B.b5())return[];
let v=[];try{v=await $j1(L,I,!1)}catch(F){}return fdV(d,v,I,"musicPlaylist")},$t9=function(d){let L;
d=g.U(d.getWatchNextResponse()?.currentVideoEndpoint,g.vg);d?.playlistId&&(L=d.playlistId);return L},xt9=async function(d,L){const I=L.clientPlaybackNonce,v={cpn:I,
offlineSourceVisualElement:g.jS(L.Z||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};L.W&&(v.videoFmt=Number(L.W.itag));L.N&&(v.audioFmt=Number(L.N.itag));const F=$t9(L);var R;if(R=F&&L.videoId)L=L.videoId,R=await (F!=="PPSV"?Promise.resolve(!1):d.O.N0(L));R&&(v.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");d.W=I;g.a6("offlinePlaybackStarted",v)};
g.QJ.prototype.P6=g.Ii(42,function(d){return this.app.P6(d)});
g.$7.prototype.P6=g.Ii(41,function(d){return g.CD$(this,9,d)});
var L3=class{constructor(d){this.O=d}},II=class extends L3{get entityMetadata(){return this.O.entityMetadata}set entityMetadata(d){this.O.entityMetadata=d}},YQ$=class extends L3{W(){const d=[];this.O.video&&d.push(this.O.video);return[...(new Set(d))]}},SQ9=class extends L3{W(){const d=[];this.O.video&&d.push(this.O.video);this.O.playlist&&d.push(this.O.playlist);this.O.videoItem&&d.push(this.O.videoItem);this.O.playlistItem&&d.push(this.O.playlistItem);return[...(new Set(d))]}},Ut9=class extends L3{W(){const d=
[];this.O.localImageEntities&&d.push(...this.O.localImageEntities);this.O.videoDownloadContextEntity&&d.push(this.O.videoDownloadContextEntity);return[...(new Set(d))]}},sQ9=class extends L3{W(){const d=[];this.O.recommendedVideoMetadata&&d.push(...(new Ut9(this.O.recommendedVideoMetadata)).W());return[...(new Set(d))]}},qQ$=class extends L3{W(){const d=[];this.O.playbackPosition&&d.push(this.O.playbackPosition);return[...(new Set(d))]}},l$U=class extends L3{W(){const d=[];this.O.creatorEntity&&d.push(this.O.creatorEntity);
return[...(new Set(d))]}},xj$=["browse","music/browse","streaming_browse","unplugged/browse"],Ujn=["offline/playlist_sync_check"],ztL=["offline"],Yyx=["offline/offline_video_playback_position_sync"],M8n=["offline/get_playback_data_entity"],CZ=class{constructor(d){this.token=d}static async getInstance(){return new Promise(d=>{g.yo().then(L=>{L?(CZ.instance||(CZ.instance=new CZ(L)),d(CZ.instance)):d(void 0)})})}async get(d){if(d=await (await ec(this.token)).get("prefs",d)){var L=(0,g.q)();
return d.expirationTimestampMs<=L?void 0:d.value}}async set(d,L,I=31536E3){const v=(0,g.q)();d={key:d,value:L,expirationTimestampMs:v+I*1E3};await (await ec(this.token)).put("prefs",d)}async remove(d){await (await ec(this.token)).delete("prefs",d)}},aU,ZRL={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
Bp=class extends g.lQ{constructor(d,L={}){super(ZRL[d],{name:"PESEncoderError",type:d,...L});this.type=d;this.level="WARNING";Object.setPrototypeOf(this,Bp.prototype)}},N6n=class{},M6U=class extends N6n{constructor(d){super();this.O=d}G(d,L){L=jc(L);d=(new TextEncoder).encode(JSON.stringify(d));return this.O.encrypt(d,L)}W(d,L){if(!(d instanceof Uint8Array))throw new Bp("WRONG_DATA_TYPE",{Um:1});const I=new TextDecoder;L=jc(L);d=this.O.decrypt(d,L);return JSON.parse(I.decode(d))}},WRL={accountLinkStatusEntity:class extends II{W(){return[]}},
booleanEntity:class extends II{W(){return[]}},buttonEntity:class extends II{W(){return[]}},captionTrack:class extends II{W(){return[]}},channelHandle:class extends II{W(){return[]}},chatLoadingStateEntity:class extends II{W(){return[]}},chipEntity:class extends II{W(){return[]}},commerceAcquisitionClientPayloadEntity:class extends II{W(){return[]}},commerceCartListEntity:class extends II{W(){return[]}},compositeSourceEntity:class extends II{W(){return[]}},multiviewStagingEntity:class extends II{W(){const d=
[];this.O.compositeSourceKeys&&d.push(...this.O.compositeSourceKeys);return[...(new Set(d))]}},contextNoteFeedEntityPayload:class extends II{W(){return[]}},contextNoteUserRatingEntityPayload:class extends II{W(){return[]}},continuationTokenEntity:class extends II{W(){return[]}},downloadQualityPickerEntity:class extends II{W(){return[]}},downloadsPageRefreshTokenEntity:class extends II{W(){return[]}},downloadsPageViewConfigurationEntity:class extends II{W(){return[]}},downloadStatusEntity:class extends II{W(){return[]}},
dismissState:class extends II{W(){return[]}},sfvAudioItemCurrentlyPlayingEntity:class extends II{W(){return[]}},emojiFountainDataEntity:class extends II{W(){return[]}},emojiCustomizationSetEntity:class extends II{W(){return[]}},fakeChannel:class extends II{W(){const d=[];this.O.alternateChannel&&d.push(this.O.alternateChannel);this.O.alternateChannelList&&d.push(...this.O.alternateChannelList);this.O.oneofChannelEntity&&d.push(this.O.oneofChannelEntity);return[...(new Set(d))]}},fakePlaylist:class extends II{W(){const d=
[];this.O.entryCollection&&d.push(this.O.entryCollection);return[...(new Set(d))]}},fakePlaylistEntryCollection:class extends II{W(){const d=[];this.O.parentPlaylist&&d.push(this.O.parentPlaylist);if(this.O.entries)for(const L of this.O.entries)d.push(...(new YQ$(L)).W());return[...(new Set(d))]}},fakeVideo:class extends II{W(){const d=[];this.O.descriptionEntity&&d.push(this.O.descriptionEntity);this.O.creators&&d.push(...this.O.creators);this.O.theBiggestFan&&d.push(this.O.theBiggestFan);return[...(new Set(d))]}},
fakeVideoDescription:class extends II{W(){return[]}},featuredProductsEntity:class extends II{W(){return[]}},flowStateEntity:class extends II{W(){return[]}},iconBadgeEntity:class extends II{W(){return[]}},interstitialInteractionStateEntity:class extends II{W(){return[]}},likeButtonAnimationEntity:class extends II{W(){return[]}},liveChatPollStateEntity:class extends II{W(){return[]}},dataFreshnessEntity:class extends II{W(){return[]}},liveViewerLeaderboardChatEntryPointStateEntity:class extends II{W(){return[]}},
liveViewerLeaderboardPointsEntity:class extends II{W(){return[]}},liveReactionsDataEntity:class extends II{W(){return[]}},logoEntity:class extends II{W(){return[]}},macroMarkerEntity:class extends II{W(){return[]}},mainDownloadsLibraryEntity:class extends II{W(){const d=[];this.O.downloadsList&&d.push(this.O.downloadsList);this.O.smartDownloadsList&&d.push(this.O.smartDownloadsList);this.O.recommendedDownloadsList&&d.push(this.O.recommendedDownloadsList);this.O.refresh&&d.push(this.O.refresh);return[...(new Set(d))]}},
mainDownloadsListEntity:class extends II{W(){const d=[];this.O.refresh&&d.push(this.O.refresh);if(this.O.downloads)for(const L of this.O.downloads)d.push(...(new SQ9(L)).W());return[...(new Set(d))]}},mainPlaylistDownloadStateEntity:class extends II{W(){const d=[];this.O.localImageEntities&&d.push(...this.O.localImageEntities);return[...(new Set(d))]}},mainPlaylistEntity:class extends II{W(){const d=[];this.O.channelOwner&&d.push(this.O.channelOwner);this.O.videos&&d.push(...this.O.videos);this.O.collaboratorChannels&&
d.push(...this.O.collaboratorChannels);this.O.downloadState&&d.push(this.O.downloadState);this.O.refresh&&d.push(this.O.refresh);return[...(new Set(d))]}},mainPlaylistVideoEntity:class extends II{W(){const d=[];this.O.video&&d.push(this.O.video);this.O.channelContributor&&d.push(this.O.channelContributor);return[...(new Set(d))]}},mainVideoDownloadStateEntity:class extends II{W(){const d=[];this.O.playbackData&&d.push(this.O.playbackData);this.O.localImageEntities&&d.push(...this.O.localImageEntities);
this.O.videoDownloadContextEntity&&d.push(this.O.videoDownloadContextEntity);return[...(new Set(d))]}},mainVideoEntity:class extends II{W(){const d=[];this.O.owner&&d.push(this.O.owner);this.O.downloadState&&d.push(this.O.downloadState);this.O.userState&&d.push(...(new qQ$(this.O.userState)).W());this.O.additionalMetadata&&d.push(...(new sQ9(this.O.additionalMetadata)).W());return[...(new Set(d))]}},markersEngagementPanelSyncEntity:class extends II{W(){return[]}},markersVisibilityOverrideEntity:class extends II{W(){return[]}},
musicAlbumReleaseDetail:class extends II{W(){const d=[];this.O.albumRelease&&d.push(this.O.albumRelease);this.O.tracks&&d.push(...this.O.tracks);return[...(new Set(d))]}},musicAlbumReleaseDownloadMetadataEntity:class extends II{W(){const d=[];this.O.trackDownloadMetadatas&&d.push(...this.O.trackDownloadMetadatas);return[...(new Set(d))]}},musicAlbumRelease:class extends II{W(){const d=[];this.O.musicLibraryStatusEntity&&d.push(this.O.musicLibraryStatusEntity);this.O.primaryArtists&&d.push(...this.O.primaryArtists);
this.O.details&&d.push(this.O.details);this.O.userDetails&&d.push(this.O.userDetails);this.O.tracks&&d.push(...this.O.tracks);this.O.share&&d.push(this.O.share);this.O.downloadMetadata&&d.push(this.O.downloadMetadata);this.O.refresh&&d.push(this.O.refresh);return[...(new Set(d))]}},musicAlbumReleaseUserDetail:class extends II{W(){const d=[];this.O.albumRelease&&d.push(this.O.albumRelease);return[...(new Set(d))]}},musicArtistDetail:class extends II{W(){const d=[];this.O.parentArtist&&d.push(this.O.parentArtist);
return[...(new Set(d))]}},musicArtist:class extends II{W(){const d=[];this.O.details&&d.push(this.O.details);this.O.userDetails&&d.push(this.O.userDetails);return[...(new Set(d))]}},musicArtistUserDetail:class extends II{W(){const d=[];this.O.parentArtist&&d.push(this.O.parentArtist);return[...(new Set(d))]}},musicDownloadsLibraryEntity:class extends II{W(){const d=[];this.O.downloadedTracks&&d.push(...this.O.downloadedTracks);this.O.smartDownloadedTracks&&d.push(...this.O.smartDownloadedTracks);
this.O.downloadedEpisodes&&d.push(...this.O.downloadedEpisodes);this.O.downloadedAlbumReleases&&d.push(...this.O.downloadedAlbumReleases);this.O.smartDownloadedAlbumReleases&&d.push(...this.O.smartDownloadedAlbumReleases);this.O.downloadedPlaylists&&d.push(...this.O.downloadedPlaylists);this.O.smartDownloadedPlaylists&&d.push(...this.O.smartDownloadedPlaylists);this.O.metadataOnlyTracks&&d.push(...this.O.metadataOnlyTracks);return[...(new Set(d))]}},musicLibraryEdit:class extends II{W(){return[]}},
musicLibraryStatusEntity:class extends II{W(){return[]}},musicPlaylist:class extends II{W(){const d=[];this.O.tracks&&d.push(...this.O.tracks);this.O.refresh&&d.push(this.O.refresh);this.O.musicLibraryStatusEntity&&d.push(this.O.musicLibraryStatusEntity);this.O.details&&d.push(this.O.details);this.O.downloadMetadata&&d.push(this.O.downloadMetadata);this.O.sideloadMetadata&&d.push(this.O.sideloadMetadata);this.O.userDetails&&d.push(this.O.userDetails);this.O.entryCollection&&d.push(this.O.entryCollection);
this.O.share&&d.push(this.O.share);this.O.podcastShowAdditionalMetadata&&d.push(...(new l$U(this.O.podcastShowAdditionalMetadata)).W());return[...(new Set(d))]}},musicPlaylistDownloadMetadataEntity:class extends II{W(){const d=[];this.O.trackDownloadMetadatas&&d.push(...this.O.trackDownloadMetadatas);return[...(new Set(d))]}},musicShare:class extends II{W(){return[]}},musicTrackDetail:class extends II{W(){const d=[];this.O.parentTrack&&d.push(this.O.parentTrack);return[...(new Set(d))]}},musicTrackDownloadMetadataEntity:class extends II{W(){const d=
[];this.O.playbackData&&d.push(this.O.playbackData);this.O.localImageEntities&&d.push(...this.O.localImageEntities);this.O.videoDownloadContextEntity&&d.push(this.O.videoDownloadContextEntity);return[...(new Set(d))]}},musicTrack:class extends II{W(){const d=[];this.O.musicLibraryStatusEntity&&d.push(this.O.musicLibraryStatusEntity);this.O.artists&&d.push(...this.O.artists);this.O.audioModeVersion&&d.push(this.O.audioModeVersion);this.O.videoModeVersion&&d.push(this.O.videoModeVersion);this.O.userDetails&&
d.push(this.O.userDetails);this.O.details&&d.push(this.O.details);this.O.albumRelease&&d.push(this.O.albumRelease);this.O.share&&d.push(this.O.share);this.O.libraryEdit&&d.push(this.O.libraryEdit);this.O.downloadMetadata&&d.push(this.O.downloadMetadata);this.O.playbackPosition&&d.push(this.O.playbackPosition);this.O.lyrics&&d.push(this.O.lyrics);return[...(new Set(d))]}},musicTrackUserDetail:class extends II{W(){const d=[];this.O.parentTrack&&d.push(this.O.parentTrack);return[...(new Set(d))]}},offlineOrchestrationActionWrapperEntity:class extends II{W(){return[]}},
offlineVideoPolicy:class extends II{W(){return[]}},offlineVideoStreams:class extends II{W(){return[]}},offlineabilityEntity:class extends II{W(){return[]}},orchestrationWebSamplingEntity:class extends II{W(){const d=[];this.O.fakeChildren&&d.push(...this.O.fakeChildren);return[...(new Set(d))]}},pageHeaderEntity:class extends II{W(){return[]}},pdpStateEntity:class extends II{W(){return[]}},pinnedProductEntity:class extends II{W(){return[]}},playbackData:class extends II{W(){const d=[];this.O.transfer&&
d.push(this.O.transfer);this.O.adsPlaybackData&&d.push(...this.O.adsPlaybackData);this.O.drmLicense&&d.push(this.O.drmLicense);this.O.offlineVideoPolicy&&d.push(this.O.offlineVideoPolicy);this.O.videoDownloadContextEntity&&d.push(this.O.videoDownloadContextEntity);return[...(new Set(d))]}},playerStateEntity:class extends II{W(){return[]}},quantityIncrementerEntity:class extends II{W(){return[]}},refresh:class extends II{W(){return[]}},saveToPlaylistListEntity:class extends II{W(){return[]}},selectedChipIndexEntityPayload:class extends II{W(){return[]}},
settingEntity:class extends II{W(){return[]}},stringEntity:class extends II{W(){return[]}},suggestedFeedbackChipStateEntity:class extends II{W(){return[]}},transfer:class extends II{W(){const d=[];this.O.offlineVideoStreams&&d.push(...this.O.offlineVideoStreams);this.O.captionTrack&&d.push(...this.O.captionTrack);return[...(new Set(d))]}},trendingOfferEntity:class extends II{W(){return[]}},videoDownloadContextEntity:class extends II{W(){return[]}},videoOverviewAsyncDataEntity:class extends II{W(){return[]}},
videoPlaybackPositionEntity:class extends II{W(){return[]}},votingEntity:class extends II{W(){return[]}},ytMainChannelEntity:class extends II{W(){const d=[];this.O.userChannelDetails&&d.push(this.O.userChannelDetails);return[...(new Set(d))]}},youchatPendingResponseEntity:class extends II{W(){return[]}},ytMainDownloadedVideoEntity:class extends II{W(){const d=[];this.O.video&&d.push(this.O.video);this.O.playbackData&&d.push(this.O.playbackData);this.O.offlineVideoPolicy&&d.push(this.O.offlineVideoPolicy);
return[...(new Set(d))]}},ytMainVideoEntity:class extends II{W(){const d=[];this.O.channelOwner&&d.push(this.O.channelOwner);this.O.playbackPosition&&d.push(this.O.playbackPosition);this.O.localImageEntities&&d.push(...this.O.localImageEntities);this.O.downloadStatus&&d.push(this.O.downloadStatus);return[...(new Set(d))]}}},GaU=class{constructor(d,L){this.O=d;this.W=L;this.G={}}},QQc=class extends N6n{G(d){return d}W(d){if(d instanceof Uint8Array)throw new Bp("WRONG_DATA_TYPE",{Um:0});return d}},
zFc=class{constructor(){this.O={};this.O[0]=new QQc;if(!g.cW("aes_pes_encoder_killswitch")){var d=this.O;try{const v=g.jy();var L=jc(v);var I=new M6U(new g.Yf(L),new g.Mi(L))}catch(v){throw d=v instanceof Error?new Bp("KEY_CREATION_FAILED",{originalMessage:v.message}):new Bp("KEY_CREATION_FAILED"),g.Z(d),d;}d[1]=I}}},EJ9=class extends g.IJ{constructor(d,L){super();this.token=d;this.O=L;this.observers=[];d=new g.er.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.jy()}`);d.onmessage=this.W.bind(this);
this.channel=d}observe(d){this.observers.push(d);return()=>{const L=this.observers.indexOf(d);L>=0&&this.observers.splice(L,1)}}W(d){PQj(this,d.data)}F2(){this.channel.close()}},xL;var WU1=new g.X("elementsCommand");var WQ=new g.X("entityBatchUpdate");var nTn=new g.X("downloadStatusEntity");var dtH=new g.X("mainPlaylistEntityActionMetadata");var TT=new g.X("mainVideoEntityActionMetadata");var mj8=new g.X("musicPlaylistEntityActionMetadata");var d8=new g.X("musicTrackEntityActionMetadata");var at8=new g.X("offlineOrchestrationActionCommand");var rk$=new g.X("localImageEntityActionMetadata");var hB=new g.X("playbackDataActionMetadata");var RPc=new g.X("transferEntityActionMetadata");var VKj=new g.X("videoPlaybackPositionEntityActionMetadata");var ZJx=class{constructor(){this.O=new Map}},U1;g.pw("","downloadsPageViewConfigurationEntity");g.pw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");var aX=g.pw("DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS","mainDownloadsListEntity");g.pw("DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS","refresh");g.pw("SMART_DOWNLOADS_ENABLED","settingEntity");new g.AA;new g.AA;var Tfb=class{constructor(){this.locks=navigator.locks}request(d,L={},I){return this.locks.request(d,L,v=>I(v))}};var NV=g.er.caches,Z8,MV,ck$=class{open(d){return NV.open(lw(d))}has(d){return NV.has(lw(d))}delete(d){return NV.delete(lw(d))}async match(d,L){var I=await this.keys();for(const v of I)if(I=await (await this.open(v)).match(d,L))return I}},djj=class extends ck${async keys(){const d=[],L=g.jy("CacheStorage keys");var I=await NV.keys();for(const v of I){I=v.indexOf(":");const {sD:F,datasyncId:R}=I===-1?{sD:v}:{sD:v.substring(0,I),datasyncId:v.substring(I+1)};R===L&&d.push(F)}return d}};var V6j=class extends g.IJ{constructor(d){super();this.api=d;this.oo={iU1:()=>this.O,
fhy:()=>this.W};
typeof g.er.BroadcastChannel!=="undefined"&&(this.O=new g.er.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.jy()}`),this.O.onmessage=this.G.bind(this),this.W=new g.er.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.jy()}`),this.W.onmessage=this.N.bind(this))}G(d){g.cg(this.api,"onOfflineOperationFailure",d.data)}N(d){this.api.publish("offlinetransferpause",d.data)}F2(){this.O?.close();this.W?.close()}};var f$j=class{constructor(d,L,I){this.j=d;this.U=L;this.visibility=I;this.L=this.B=this.K=this.G=this.O=!1;this.N=new g.Rk(()=>{this.pu()});
this.oo={a4:()=>this.W,
pu:()=>{this.pu()},
ge2:()=>this.N};
this.visibility.subscribe("visibilitystatechange",()=>{this.X0()})}X0(){this.O&&VZ(this)}pu(){this.W&&this.W.resolve();
this.G=this.O=!1;this.U()}};var tI8=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var HQ=class{constructor(d,L,I,v,F=L,R,D,O,b,H,n){this.entityType=d;this.actionId=L;this.action=I;this.parentActionId=v;this.rootActionId=F;this.childActionIds=R;this.prereqActionId=D;this.postreqActionIds=O;this.hasChildActionFailed=H;this.retryScheduleIndex=0;this.O=n||Date.now();this.retryScheduleIndex=b||0}};var KUb="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var P9U="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var vj=class{constructor(d){this.O=d}},JB=class{constructor(d,L,I,v,F,R){this.status=d;this.O=L;this.N=I;this.W=v;this.G=F;this.downloadState=R}};var T6H=class extends vj{constructor(d,L,I){super(d);this.O=d;this.Hy=L;this.G=I}W(d){return X9(d)?ZmQ(this,d):d7(d)?Q5j(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}};var g4$=class extends vj{constructor(d,L){super(d);this.O=d;this.Hy=L}W(d){return d7(d)?cZ$(this,d):Hm$(d)?ft1(this,d):LZ(d)?Tbx(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}};var Xqw=class{constructor(d,L){this.api=d;this.O=L;this.logger=new g.Gs("woffle");this.W=!1;this.oo={ge:this.ge}}async N(d){if(d.state.O(128)){const L=d.state.u5;d=L?.errorCode;d=d==="net.connect"&&L?.OL===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":d?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.ev(this.player.getVideoData().videoId,d)}}async ev(d,L){this.W||(this.W=!0,L==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?x9(this,d,!1,!0):(await $9(this,d),
g.Z9(d,4),await this.O.ev(L)))}qO(d){d.status===2?(d.status!==this.G&&(MZ(this.O),g.Z9(d.videoId,2)),d.lY&&wY1(this.O,d.videoId,d.lY)):d.status===4?($9(this,d.videoId),this.ev(d.videoId,d.EM?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):d.status===1&&Cnx(this.O);this.G=d.status;g.cg(this.api,"localmediachange",{videoId:d.videoId,status:d.status})}async BK(){if(!this.W){this.W=!0;var d=this.player.getVideoData().videoId;await $9(this,d);await this.O.BK()}}ge(d){switch(d){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}C(d){return this.api.V().C(d)}};var dq8=class extends vj{constructor(d,L){super(d);this.O=d;this.Hy=L}W(d){return X9(d)?Idw(this,d):d7(d)?vbc(this,d):Hm$(d)?FW1(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}};var LBU=class{constructor(){this.actions=[]}O(d,L){let I=d.action.actionMetadata.priority-L.action.actionMetadata.priority;I===0&&(d.O<L.O?I=-1:d.O>L.O&&(I=1));return I}};var obL=class extends g.IJ{constructor(d,L,I,v,F){super();this.W=d;this.Wy=L;this.md=I;this.B=v;this.Hy=F;this.O=new LBU;this.K=new g.y0;this.G=new g.Rk(()=>{this.retry()});
this.j=NaN;this.L=!1;this.oo={rry:()=>this.O,
dw:()=>this.K,
ahE:()=>this.G,
retry:()=>this.retry()};
g.G(this,this.G);this.U=this.W.observe(this.Z.bind(this))}F2(){this.U&&this.U();super.F2()}createAction(d,L){const I=g.AS(d.entityKey).entityType,v=g.jk(16);return new HQ(I,v,d,L.actionId,L.rootActionId)}async Z(d){if(!this.X2()){var L=d.offlineOrchestrationActionWrapperEntity??new Set;d=[];for(var I of L)({entityId:L}=g.AS(I)),nbL(this.O,L)||d.push(I);I=await Btx(this,d);await UO(this,I)}}async retry(){await pY1(this)}};var IUn=class{constructor(d){this.uU=d;this.O=void 0}async LG(d,L=!0){if(this.O){var I=[],v=g.Xd(this.O.O,L),F=[];for(let R=0;R<v.length;R++)L=this.O.K(v[R],"json3"),L=g.Oh(L,{withCredentials:!0,format:"RAW"},3,500).then(D=>{D={metadata:g.ul(v[R]),trackData:D.xhr.responseText};F.push(D)}).o5(D=>{s1("Caption fetch error",D)}),I.push(L);
await HJ1(I);try{await YZH(d,F)}catch(R){s1("Caption DB transaction error",R)}}}};var vhV=class extends g.IJ{constructor(d){super();this.O=d;this.W=this.O.observe(this.G.bind(this))}F2(){this.W&&this.W();super.F2()}async G(d){var L=d.transfer??new Set;d=[];for(const I of L)({entityId:L}=g.AS(I)),d.push(L);d.length!==0&&await u78(this,d)}};var MIL=class extends g.IJ{constructor(d,L,I,v){super();this.W=d;this.api=L;this.bU=I;this.Z=v;this.K=new g.y0;this.N=new g.Rk(()=>{this.O&&this.O.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.K.b5()&&((this.O.transferRetryCount||0)<3?x9(this.B,this.L,!1,!1):$9(this.B,this.L.videoDetails.videoId),this.ev("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.md=this.sU=0;this.U=this.j=!1;this.K1=g.rP(this.api.V().experiments,"html5_transfer_processing_logs_interval");this.tU=new g.LN(this);this.oo={Mf0:()=>this.N,
yr2:()=>this.Z,
dw:()=>this.K};
this.Wy=this.W.observe(this.aL.bind(this));this.B=new Xqw(L,this);this.M0=new IUn(L);this.N0=new vhV(this.W);this.Sj=this.K.listen("publicytnetworkstatus-online",this.Zs.bind(this));this.L1=this.K.listen("publicytnetworkstatus-offline",this.By.bind(this));this.U=this.api.V().C("html5_less_transfer_processing_logs");g.G(this,this.tU);this.tU.A(L,"offlinetransferpause",this.jj);if(g.EF(this.api.V()))this.G="mainVideoDownloadStateEntity";else if(g.fV(this.api.V())||g.oD(this.api.V()))this.G="musicTrackDownloadMetadataEntity"}F2(){this.Wy&&
this.Wy();this.N0.dispose();this.N.dispose();this.Sj&&g.uG(this.K.EJ,this.Sj);this.L1&&g.uG(this.K.EJ,this.L1);super.F2()}async jj(d){const L=g.pw(d,"transfer");if(this.O&&L===this.O.key)x9(this.B,this.L,!0),this.N.stop();else{const I=await wl(this.W,{mode:"readwrite",Bx:!0},v=>pS(v,L,"transfer").then(F=>{if(F&&F.transferState!=="TRANSFER_STATE_COMPLETE"&&F.transferState!=="TRANSFER_STATE_FAILED")return F.transferState="TRANSFER_STATE_PAUSED_BY_USER",m2(v,F,"transfer").then(()=>F)}));
if(I){d&&this.G&&await IX(d,this.G,this.W,"DOWNLOAD_STATE_PAUSED");const v=await qZ(this,d);Omw({videoId:d,pT:I,offlineModeType:v})}}}By(){if(this.O&&this.L){x9(this.B,this.L,!1);const d=this.O,L=d?.key?g.AS(d.key).entityId:"";L&&this.G&&(new Promise((I,v)=>{IX(L,this.G,this.W,"DOWNLOAD_STATE_PAUSED").catch(F=>{v(F)})})).catch(I=>{s1("Download state setting error",I)})}this.N.stop()}Zs(){this.O?sN1(this,this.O):NZ(this)}async aL(d){if(this.O&&(this.O.transferState!=="TRANSFER_STATE_COMPLETE"&&this.O.transferState!==
"TRANSFER_STATE_FAILED"&&d.transfer&&d.transfer.has(this.O.key)&&((this.O=await iw(this.W,this.O.key,"transfer"))||await qV1(this)),this.O))return;
await NZ(this)}async ev(d,L){if(this.O){var I=this.O;const F=I?.key?g.AS(I.key).entityId:"";a:switch(d){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var v=!1;break a;default:v=!0}v&&ldV(this)?(await sO(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),d=await qZ(this,F),Tn({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:F,pT:I,offlineModeType:d}),
F&&this.G&&await IX(F,this.G,this.W,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await ZG1(this,d),F&&this.G&&await IX(F,this.G,this.W,"DOWNLOAD_STATE_FAILED"))}else lo(this,`onTransferFailure: ${d}`);ZX(this);I=NZ(this,!0);L&&L(I)}async BK(d){if(this.O)if(ldV(this)){await sO(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.O||lo(this,"onMaybeTransferStreamsExpiredRetryAttempting");var L=this.O,I=L?.key?g.AS(L.key).entityId:"",v=await qZ(this,I);Tn({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:I,pT:L,offlineModeType:v});L=bo();g.sG(L,hB,{isEnqueuedForExpiredStreamUrlRefetch:!0});v=g.pw(I,"playbackData");I=oX(new HQ("playbackData",I,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:v,actionMetadata:L}));await Jw(this.W,I,"offlineOrchestrationActionWrapperEntity")}else await ZG1(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.G&&(I=this.O,(I=I?.key?g.AS(I.key).entityId:"")&&await IX(I,this.G,this.W,"DOWNLOAD_STATE_FAILED"));else lo(this,"onMaybeTransferStreamsExpired");
ZX(this);I=NZ(this,!0);d&&d(I)}},Qv={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var FBU=class{constructor(d,L){this.Hy=d;this.api=L;this.B=new g.y0;this.L=new g.AA;this.oo={a4:()=>this.G.oo.a4(),
dw:()=>this.B,
FHU:()=>this.G,
Rl:()=>this.Rl(),
Sz:()=>this.Sz(),
gk:()=>this.gk(),
At:()=>this.At(),
Y9:()=>this.Y9(),
Bv:I=>this.Bv(I)};
this.G=new f$j(()=>Nt9(this),()=>{this.gk()},this.api.yC(),this.api.C.bind(this.api));
this.O=new V6j(this.api);Itx(this.G)}Rl(){return this.L.promise}Sz(){if(this.W&&this.j)return this.L.promise;cPV(this).then(this.L.resolve).catch(this.L.reject);return this.L.promise}K(d){return{playbackData:new T6H(d,this.Hy,this.O),transfer:new dq8(d,this.Hy),videoPlaybackPositionEntity:new g4$(d,this.Hy)}}async At(){this.W&&await iG$(this.W)}async gk(){if(this.W||this.j)await this.Rl(),this.md!==void 0&&(g.ME(this.md),this.md=void 0),this.N!==void 0&&(g.ME(this.N),this.N=void 0),this.W?.dispose(),
this.W=void 0,this.j?.dispose(),this.j=void 0,g.cg(this.api,"onOrchestrationLostLeader"),this.L=new g.AA}isOrchestrationLeader(){return this.G.O}async N0(){return!1}P1(d){var L=this.O;L.api.publish("offlinetransferpause",d);L.W?.postMessage(d)}async Zs(d){const L=await YL();if(L){var I=g.pw(d,"transfer");await wl(L,{mode:"readwrite",Bx:!0},v=>{const F=pS(v,I,"transfer"),R=pS(v,g.pw(d,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.lq.all([F,R]).then(([D,O])=>D&&D.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(D.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",m2(v,D,"transfer").then(()=>{Tn({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:d,pT:D,offlineModeType:O?.offlineModeType});return g.lq.resolve(null)})):g.lq.resolve(null))})}}async Wy(d=43200){if(!this.B.b5())return VI$();
var L=await YL();if(!L)return[];const I=Date.now()/1E3;var v=await $L(L,"offlineVideoPolicy");L=[];for(const F of v)Number(F.lastUpdatedTimestampSeconds)+d<=I&&(v=g.AS(F.key).entityId,L.push(v));return L.length?cQ(this,L,this.Z,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return cQ(this,["!*$_ALL_ENTITIES_!*$"],this.Z,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(d){return await this.Wy(d)}setUpPositionSyncInterval(d){this.N!==
void 0&&(g.ME(this.N),this.N=void 0);const L=d??864E5;this.N=g.Zc(()=>{this.Bv(L)},L)}async Bv(d){try{const L=await CZ.getInstance();
if(!L)throw Error("prefStorage is undefined");const I=await L.get("psi"),v=I?.Il?Number(I.Il)/1E3:0,F=Date.now();v+d<=F&&await cQ(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(L){s1("Offline manager error",L)}}async Y9(){var d=await YL();if(!d)return[];var L=await $L(d,"transfer");d=[];for(const I of L)I.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&I.key&&(L=g.AS(I.key).entityId,d.push(L));return Ttc(this,d)}async U(){return[]}async L1(){}async sU(){}};var Rm$=class extends vj{constructor(d,L,I){super(d);this.O=d;this.Hy=L;this.G=I}W(d){return X9(d)?XYQ(this,d):d7(d)?LdL(this,d):LZ(d)?I$n(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}},Vv=[10];var Dqb=class extends vj{constructor(d,L,I){super(d);this.O=d;this.Hy=L;this.G=I}W(d){return X9(d)?HRj(this,d):d7(d)?n48(this,d):LZ(d)?o4$(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}},bRn=[10];var OY$=class extends vj{constructor(d,L,I){super(d);this.O=d;this.Hy=L;this.G=I}W(d){return d7(d)?kxQ(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}};var bYj=class extends FBU{constructor(){super(...arguments);this.Z="mainVideoEntity"}K(d){const L=super.K(d);L.mainVideoEntity=new Dqb(d,this.Hy,this.O);L.mainPlaylistEntity=new Rm$(d,this.Hy,this.O);L.mainDownloadsListEntity=new OY$(d,this.Hy,this.O);return L}async refreshAllStaleEntities(d,L){let I=[];this.Hy.C("web_player_offline_playlist_auto_refresh")&&(I=await Kdw(this,d,L));var v=await CZ.getInstance();const F=await v?.get("sdois");v=await v?.get("lmqf");F&&(I=I.concat(await es$(this,F,v??
"SD",d===0)));return I=I.concat(await super.refreshAllStaleEntities(d,L))}async N0(d){var L=await YL();if(!L)return!1;L=await iw(L,aX,"mainDownloadsListEntity");if(L?.downloads?.length){d=g.pw(d,"mainVideoEntity");for(const I of L.downloads)if(I.videoItem===d)return!0}return!1}async U(){var d=await YL();if(!d)return[];var L=await $L(d,"downloadStatusEntity");d=[];for(const I of L)I.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&I.key&&(L=g.AS(I.key).entityId,d.push(L));return d.length?cQ(this,d,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async sU(){const d=await YL();d&&await wl(d,{mode:"readwrite",Bx:!0},L=>Pp(L,"mainVideoEntity").then(I=>{const v=[];for(const F of I){if(F.userState?.playbackPosition)continue;I=g.AS(F.key).entityId;I={key:g.pw(I,"videoPlaybackPositionEntity"),videoId:I,lastPlaybackPositionSeconds:"0"};v.push(m2(L,I,"videoPlaybackPositionEntity"));F.userState={playbackPosition:I.key};v.push(m2(L,
F,"mainVideoEntity"))}return g.lq.all(v)}))}async L1(){const d=await YL();
if(d){var L=g.pw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),I=await wl(d,{mode:"readonly",Bx:!0},y=>g.lq.all([pS(y,L,"mainDownloadsListEntity"),pS(y,aX,"mainDownloadsListEntity"),Pp(y,"mainVideoEntity"),Pp(y,"mainPlaylistEntity")])),[v,
F,R,D]=I;I=new Set;if(v?.downloads?.length)for(var O of v.downloads){var b=O.videoItem??O.playlistItem;b&&I.add(b)}if(F?.downloads?.length)for(var H of F.downloads)H.videoItem&&I.add(H.videoItem);O=new Set;H=[];for(var n of D){if(n.videos)for(const y of n.videos)(b=JSON.parse(g.AS(y).entityId).videoId)&&O.add(b);n.key&&!I.has(n.key)&&H.push(n.key)}for(const y of R)y.key&&!I.has(y.key)&&(n=g.AS(y.key).entityId,O.has(n)||H.push(y.key));H.length&&await BQ(d,H)}}};var HYL=class extends vj{constructor(d,L){super(d);this.O=d;this.G=L}W(d){return X9(d)?a$x(this,d):d7(d)?B6Q(this,d):LZ(d)?jQV(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}},g7=[10];var nhU=class extends vj{constructor(d,L){super(d);this.O=d;this.G=L}W(d){return X9(d)?pq8(this,d):d7(d)?PZQ(this,d):LZ(d)?Gx8(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}},XD=[10];var ohV=class extends vj{constructor(d,L){super(d);this.O=d;this.G=L}W(d){return X9(d)?hsn(this,d):d7(d)?wqL(this,d):LZ(d)?Jkb(this,d):Promise.reject(Error(`Unsupported action type: ${d.actionType}`))}},E4V=[10];var yX9=class extends FBU{constructor(){super(...arguments);this.Z="musicTrack"}K(d){const L=super.K(d);L.musicTrack=new ohV(d,this.O);L.musicPlaylist=new nhU(d,this.O);L.musicAlbumRelease=new HYL(d,this.O);return L}async refreshAllStaleEntities(d,L){let I=await iR1(this,d,L);return I=I.concat(await super.refreshAllStaleEntities(d,L))}};g.au("offline",class extends g.WN{constructor(){super(...arguments);this.events=new g.LN(this);this.Hy=this.player.V();this.oo={sNy:()=>this.O,
V4:()=>this.V4(),
h$:d=>this.h$(d)}}create(){g.G(this,this.events);
if(g.EF(this.Hy))this.O=new bYj(this.Hy,this.player);else if(g.fV(this.Hy)||g.oD(this.Hy))this.O=new yX9(this.Hy,this.player);this.events.A(this.player,"onPlaybackStartExternal",()=>{this.V4()});
this.events.A(this.player,"videodatachange",()=>{this.V4()});
this.Hy.C("html5_offline_playback_position_sync")&&this.events.A(this.player,"presentingplayerstatechange",this.h$)}Yy(){return!1}async yB(d,L,I,v){return this.O?cQ(this.O,d,L,I,v):Promise.reject()}deleteAll(){return this.O.deleteAll()}Wy(d){return this.O.Wy(d)}refreshAllStaleEntities(d){return this.O.refreshAllStaleEntities(d)}setUpPositionSyncInterval(d){this.O.setUpPositionSyncInterval(d)}P1(d){this.O.P1(d)}Zs(d){return this.O.Zs(d)}async V4(){const d=this.player.getVideoData();d.Sl()&&$t9(d)&&
this.W!==d.clientPlaybackNonce&&await xt9(this,d)}async h$(d){var L=this.player.getVideoData();const I=L.Px;if(d.yR(2)||d.yR(512))(d=await YL())?(L=L.videoId,await iw(d,g.pw(L,"mainVideoEntity"),"mainVideoEntity")&&await this.yB([L],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(I).toString()}})):s1("PES is undefined")}isOrchestrationLeader(){return this.O.isOrchestrationLeader()}async updateDownloadState(d,
L){const I=await YL();if(I){var {entityType:v,entityId:F}=g.AS(d);await IX(F,v,I,L,!0)}else s1("PES is undefined")}});})(_yt_player);
